<div class="mt-3">
    <header class="mb-2">
        <h1 class="display-4">HashiCorp Vault sur Synology : <br />Fini les
            certificats pourris ! üîê</h1>
        <h3 class="lead text-muted">Ou comment j'ai arr√™t√© de pleurer devant
            mes
            certificats auto-sign√©s</h3>
    </header>

    <section class="alert alert-primary border-left-primary" role="alert">
        <h5>TL;DR pour les press√©s</h5>
        <p class="mb-0">On va installer Vault sur un Synology pour g√©n√©rer et
            renouveler automatiquement nos certificats SSL. Plus jamais
            d'erreurs "certificat non valide" dans le navigateur ou pour connecter un
            service, plus jamais de
            weekend g√¢ch√© √† renouveler manuellement des certificats expir√©s.
            Promise de dev ! ü§û</p>
    </section>

    <section>
        <h2 class="pb-3 pt-2">ü§¶‚Äç‚ôÇÔ∏è Le probl√®me qu'on conna√Æt tous</h2>

        <p>Bon, soyons honn√™tes. Qui n'a jamais eu ce moment de pure frustration
            :</p>

        <div class="card bg-light mb-4">
            <div class="card-body">
                <p class="font-italic mb-0">"Putain, mais pourquoi mon certificat
                    SSL a expir√© un dimanche √† 23h45 ? Et bien s√ªr, c'est pile
                    au moment o√π le patron veut montrer la nouvelle
                    fonctionnalit√© √† ses potes..."</p>
            </div>
        </div>

        <p>Ou alors cette magnifique erreur qui fait toujours plaisir :</p>

        <div class="alert alert-danger mb-4">
            <strong>NET::ERR_CERT_AUTHORITY_INVALID</strong>
            <p class="mb-0">
                Votre connexion n'est pas priv√©e. Des individus malveillants
                tentent peut-√™tre de d√©rober vos informations...
            </p>
        </div>

        <p>Yeah, g√©nial ! Sans compter que parfois c'est un service qui te le sort et
            lui il n'arrive carr√©ment pas √† se connecter avec ! üòÖ</p>

        <p>Et ne parlons pas de ces moments o√π tu configures ton homelab avec
            des certificats auto-sign√©s "juste pour tester", et que 6 mois plus
            tard tu t'aper√ßois que la moiti√© de tes services sont encore en HTTP
            ou avec des certificats foireux.</p>

        <blockquote class="blockquote p-4 my-4">
            <p>"Il n'y a que deux types de d√©veloppeurs : ceux qui ont d√©j√† eu
                des probl√®mes de certificats, et ceux qui mentent."</p>
            <footer class="blockquote-footer">Un sage d√©veloppeur, probablement
            </footer>
        </blockquote>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üí° La solution : Vault + Synology = ‚ù§Ô∏è</h2>

        <p>Alors voil√† l'id√©e g√©niale (bon, pas de moi, merci HashiCorp) :
            utiliser <strong>HashiCorp Vault</strong> comme une PKI (Public Key
            Infrastructure) pour g√©n√©rer automatiquement nos certificats SSL.
        </p>

        <p>Mais attention, on ne va pas juste installer Vault et l'oublier dans
            un coin. Non non non. On va faire √ßa proprement avec :</p>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-primary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 data-no-menu class="card-title mt-2"><i class="fas fa-database"></i> Consul</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Notre backend de stockage. Parce
                            que Vault tout seul, c'est comme un frigo vide : √ßa
                            sert √† rien.</p>
                        <small class="text-muted">Stockage distribu√©, haute
                            disponibilit√©, tout √ßa...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mt-4 mt-md-0">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white">
                        <h5 data-no-menu class="card-title mt-2"><i class="fas fa-key"></i> Vault</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Le chef d'orchestre. Il g√©n√®re les
                            certificats, g√®re les secrets, et fait tout √ßa de
                            mani√®re s√©curis√©e.</p>
                        <small class="text-muted">PKI, secrets management, API
                            REST...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mt-4 mt-md-0">
                <div class="card border-warning h-100">
                    <div class="card-header bg-warning text-white">
                        <h5 data-no-menu class="card-title mt-2"><i class="fas fa-robot"></i> Vault-Agent</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Le petit robot qui fait le sale
                            boulot : r√©cup√®re les certificats et les d√©ploie
                            automatiquement.</p>
                        <small class="text-muted">Templating, d√©ploiement,
                            red√©marrage des services...</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>Mais pourquoi sur Synology ?</strong>
            <p class="mb-0">Parce que ton NAS Synology tourne H24, qu'il a
                Docker, et qu'il est parfait pour h√©berger ce genre de services
                d'infrastructure ! Et puis soyons honn√™tes, on a tous un
                Synology qui tourne dans un coin, autant qu'il serve √† quelque
                chose d'utile. üòè Oui, oui Netflix tu m'as vu üôÉ </p>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üèóÔ∏è Architecture de notre petit chef-d'≈ìuvre</h2>

        <p>Bon, avant de se lancer t√™te baiss√©e dans les commandes, comprenons
            un peu ce qu'on va construire :</p>

        <div class="card mb-4">
            <div class="card-body">
                <strong>Phase 1 : "Houston, we have a problem"</strong>
                <p>Au d√©but, notre Vault back√© par Consul sera accessible en
                    HTTP (oui, je sais, c'est ironique pour un truc qui g√®re la
                    s√©curit√©). Mais c'est temporaire, le temps qu'on configure
                    tout.</p>

                <strong>Phase 2 : "The magic happens"</strong>
                <p>Une fois configur√©, Vault-Agent va :</p>
                <ul class="mt-2">
                    <li>Se connecter √† Vault avec ses identifiants en HTTP.
                        <br />Mais lui il sera sur le r√©seau Docker donc il a le
                        droit !
                    </li>
                    <li>G√©n√©rer un nouveau certificat SSL</li>
                    <li>Le d√©ployer dans le bon r√©pertoire de Synology</li>
                    <li>Red√©marrer Nginx pour prendre en compte le nouveau
                        certificat</li>
                    <li>R√©p√©ter tout √ßa automatiquement avant expiration</li>
                </ul>

                <strong>Phase 3 : "Profit!"</strong>
                <p class="mb-0">R√©sultat : on acc√®de √† Vault en HTTPS depuis l'exterieur
                    avec un certificat
                    valide, et tous nos autres services peuvent b√©n√©ficier du
                    m√™me syst√®me !</p>
            </div>
        </div>

        <div class="alert alert-success">
            <strong>Le truc cool</strong>
            <p>Une fois que c'est en place, tu peux g√©n√©rer des
                certificats pour tous tes services internes : le NAS,
                Portainer, ton API maison, etc. Un seul endroit pour g√©rer tous
                tes certificats !
            </p>
            <p class="mb-0">Autre point positif : Vault est
                g√©n√©rique, tu n'es m√™me pas oblig√© de lui faire g√©n√©rer des
                certificats : tu peux aussi lui en fournir comme...
                ceux d'un Let's Encrypt avec un Cerbot pour exposer ton service
                sur Internet par example üòâ <br /> Mais cela sera l'object d'un
                autre article notament sur Kubernetes avec Cert-manager pour
                celles et ceux qui conaissent d√©j√†. </p>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üìÅ Structure du projet (ou "comment s'organiser
            comme un chef")</h2>
        <p>Treve de bavardage, passons √† la pratique</p>
        <p>On commence par cr√©er notre petite architecture. Parce que oui,
            l'organisation c'est important (m√™me si on fait tous semblant de
            s'en foutre) :</p>
        <p>Le point de d√©part sur mon Synology o√π je vais travailler : </p>
        <ul class="mt-2">
            <li>sur la partition RAID1 que j'ai cr√©e : <kbd>volume1</kbd></li>
            <li>dans un dossier partag√© : <kbd>docker</kbd> qui me sert bah √†
                tous mes Dockers hein logique ! En plus il backup√© sur AWS toutes
                les nuits donc les configs ne vont pas s'envoler üòâ.</li>
            <li>dans un dossier sp√©cifique : <kbd>secret</kbd> afin de ne pas
                m√©langer les choux et les carottes.</li>
        </ul>
        <div class="card">
            <div class="card-header">
                <h6 class="mt-2"><i class="fas fa-folder-open"></i> Arborescence
                    du projet</h6>
            </div>
            <div class="card-body">
                <pre class="rounded px-3 m-3"><code class="text-dark">üìÅ /volume1/docker/secret/
‚îú‚îÄ‚îÄ üê≥ swarm_consul_vault.yml          # Orchestration pour Consul & Vault
‚îú‚îÄ‚îÄ üê≥ swarm_vault_agent.yml           # Orchestration pour Vault-Agent
‚îú‚îÄ‚îÄ üìÅ consul/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ server.hcl           # Config Consul
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ start-consul.sh      # Script de d√©marrage
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ data/                    # Donn√©es Consul (g√©n√©r√© auto)
‚îú‚îÄ‚îÄ üìÅ vault/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ vault.hcl            # Config Vault
‚îî‚îÄ‚îÄ üìÅ vault-agent/
    ‚îú‚îÄ‚îÄ üìÅ config/
    ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ agent.hcl            # Config de l'agent
    ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ restart_service.sh   # Script de red√©marrage
    ‚îî‚îÄ‚îÄ üìÅ templates/     
        ‚îî‚îÄ‚îÄ üìÑ cert.tpl            # Template de certificat</code></pre>
            </div>
        </div>

        <p class="mt-3">Chaque dossier a son r√¥le, chaque fichier a sa mission.
            C'est beau, c'est organis√©, √ßa donne envie de pleurer de bonheur !
            ü•≤</p>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üöÄ Phase 1 : On met le bazaar en place</h2>

        <p>Bon, maintenant qu'on a compris le principe, on va passer aux choses
            s√©rieuses. Pr√©pare-toi un bon caf√©, on va faire du Docker Swarm !
        </p>
        <p>Oui je sais tu ne l'avais pas vu venir celle-l√† hein ‚ò∫Ô∏è!</p>
        <p>La v√©rit√© c'est que l'interface Docker de Synology est bien trop
            limit√©. Deplus sur le long terme si tu as envie d'avoir
            plusieurs Synology, tu pouras √©tandre le Swarm dessus (et donc
            notament le vault-agent automatiquement) pas mal hein !</p>

        <div class="alert alert-warning">
            <strong>Attention, moment critique !</strong>
            <p class="mb-0">Avant de commencer, assure-toi d'avoir acc√®s SSH √†
                ton Synology et que Docker est install√© ET configur√©. Si tu ne sais pas
                comment faire, Google est ton ami (ou ChatGPT, on ne juge pas).
            </p>
        </div>
    </section>

    <section>
        <div class="card my-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-play"></i> √âtape 1 :
                    Initialisation du swarm</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row align-items-center gap-3">
                    <img class="balaine-side" src="../../assets/images/synology-vault/balaine.webp"
                        alt="Ma jolie baleine">
                    <div>
                        <p>Premi√®re √©tape : on active notre Docker en mode Swarm.
                            Pourquoi ? Parce que √ßa nous permet d'utiliser les secrets
                            Docker (bien plus s√©curis√© que des variables
                            d'environnement).</p>
                        <p class="mb-0">
                            Je ferai probablement un article sur Docker Swarm. Je trouve
                            cette techno vraiment sous-estim√©e alors qu'elle peut rendre
                            de sacr√©s services (comme ici), surtout face au monstre
                            Kubernetes qui demande √©normement de configuration. Mais bon, restons
                            concentr√©s, on n'est pas l√†
                            pour parler des Godzilla du cloud !
                        </p>
                    </div>
                </div>

                <pre class="bg-dark text-light p-3 rounded my-3">
<code class="language-bash"># On active le mode swarm sur l'interface r√©seau principale (chez moi c'est la premiere eth0)
docker swarm init --advertise-addr eth0
</code></pre>
                <p>Bon, l√† il n'y a pas grand-chose √† dire : Docker est d√©j√†
                    install√© via le gestionnaire de paquets de Synology, et
                    Swarm est nativement int√©gr√© √† Docker Engine depuis pr√®s de
                    dix ans.</p>
                <p>Pensez simplement √† enregistrer le token, au cas o√π tu
                    souhaiterais ajouter d'autres Synology au cluster Swarm √†
                    l'avenir.</p>
                <p class="mb-0">Dans l'absolu, nous allons utiliser tr√®s peu de
                    fonctionnalit√©s de Swarm : d√©ploiement, r√©plication,
                    exposition de services et gestion des secrets.</p>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-layer-group"></i> √âtape 2 : D√©ploiement de la stack
                </h5>
            </div>
            <div class="card-body">
                <p>
                    Dans les sections suivantes, nous allons d√©cortiquer chaque fichier de configuration que j'ai
                    pr√©sent√© dans l'arborescence du projet. Des <code>orchestrations yaml</code> jusqu'au
                    <code>template Vault</code> en
                    passant par les <code>scripts de d√©marrage</code>, chaque ligne sera expliqu√©e avec le soin d'un
                    d√©veloppeur qui
                    documente son code... parce que oui, √ßa arrive parfois !
                </p>
                <p>
                    Alors, sort ton caf√© ‚òï, ouvrez ton √©diteur pr√©f√©r√© (et non, Notepad ne compte pas), et
                    on va attaquer ces YAML, HCL et Bash scripts qui vont transformer ton NAS en
                    v√©ritable coffre-fort num√©rique.
                </p>
                <div class="accordion" id="accordionPanelsStayOpenExample">
                    <div class="accordion" id="accordionPanelsStayOpenExample">
                        <!-- Bloc swarm_consul_vault.yml -->
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-consulVault" aria-expanded="false"
                                    aria-controls="panelsStayOpen-consulVault">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">swarm_consul_vault.yml</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-consulVault" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Stack 1 ‚Äî Consul + Vault :</strong>
                                    <p>
                                        Cette stack d√©ploie les services <code>consul</code> et <code>vault</code> avec
                                        leurs volumes, r√©seaux et configurations sp√©cifiques. Elle utilise une syntaxe
                                        compatible Docker Compose, que Docker Swarm comprend et interpr√®te sans souci.
                                    </p>
                                    <p>
                                        Cette premi√®re stack pr√©pare le backend de stockage de Vault avec Consul, et
                                        d√©ploie Vault en mode serveur.
                                    </p>
                                    <div class="alert alert-warning">
                                        <strong>Important :</strong> Toujours d√©ployer cette stack en premier. Le
                                        Vault-Agent (stack 2) d√©pendra de ce serveur et ne fonctionnera pas sans.
                                    </div>

                                    <strong>Explications des options cl√©s :</strong>
                                    <ul>
                                        <li><code>cap_add: IPC_LOCK</code> : Permet √† Vault de verrouiller sa m√©moire et
                                            √©viter que des secrets ne soient √©chang√©s sur le disque.</li>
                                        <li><code>volumes</code> : Persistence des informations, chargement des
                                            configurations et synchronisation de l'heure avec l'h√¥te via
                                            <code>/etc/localtime</code> pour √©viter les probl√®mes de logs et
                                            certificats.
                                        </li>
                                        <li><code>secrets:</code> Les cl√©s de chiffrement sont inject√©es de fa√ßon
                                            s√©curis√©e via les secrets Swarm.</li>
                                        <li><code>networks: secret</code> : Un r√©seau overlay Swarm d√©di√©
                                            pour isoler la communication entre services.</li>
                                        <li><code>healthcheck</code> : Teste p√©riodiquement la disponibilit√© des
                                            services (ex: API Consul, endpoint sant√© Vault).</li>
                                        <li><code>deploy.restart_policy</code> : Param√®tres pour g√©rer automatiquement
                                            la r√©silience en cas d'erreurs.</li>
                                    </ul>

                                    <p>
                                        Voici le fichier <code>swarm_consul_vault.yml</code> complet avec tous les
                                        commentaires qui expliquent chaque section en d√©tail :
                                    </p>

                                    <pre class="bg-dark text-light p-3 rounded mh-100" style="white-space: pre-wrap;">
<code class="language-yaml">version: "3.8"

services:
  consul:
    image: hashicorp/consul:1.17
    ports:
      # Port web UI et API Consul
      - "8500:8500"
    volumes:
      # Configuration de Consul en lecture seule
      - /volume1/docker/secret/consul/config:/consul/config
      # Donn√©es persistantes pour Consul
      - /volume1/docker/secret/consul/data:/consul/data
      # Synchronisation de l'heure avec l'h√¥te pour coh√©rence temporelle
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Informations sur le cluster Consul
      CONSUL_DATACENTER: Low-layer
      CONSUL_DOMAIN: consul
      CONSUL_NODE_NAME: synology-01-consul
      # Cl√© de chiffrement r√©seau, inject√©e via secret
      CONSUL_ENCRYPT_KEY_FILE: /run/secrets/consul-encrypt-key
      # Identifiants utilisateur/groupe pour permissions d'acc√®s
      PUID: 1027
      PGID: 100
    command: sh /consul/config/start_consul.sh
    networks:
      - secret
    secrets:
      # Secret Consul encrypt key externe
      - consul-encrypt-key
    healthcheck:
      # Test pour v√©rifier que Consul est joignable
      test: ["CMD", "consul", "members", "-http-addr=http://localhost:8500"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 20
        window: 600s

  vault:
    image: hashicorp/vault:1.15
    cap_add:
      # Verrouillage m√©moire pour √©viter le swap des secrets sur disque
      - IPC_LOCK
    ports:
      # Port de l'API Vault et UI accessible via 8200
      - "8200:8200"
    volumes:
      # Configuration Vault
      - /volume1/docker/secret/vault/config:/vault/config
      # Synchronisation de l'heure avec l'h√¥te pour √©viter d√©rives
      - /etc/localtime:/etc/localtime:ro
    environment:
      PUID: 1027
      PGID: 100
    command: vault server -config=/vault/config/vault.hcl
    networks:
      - secret
    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 20
        window: 600s
    healthcheck:
      # V√©rifie la sant√© de Vault, accepte aussi √©tat non initialis√© ou scell√©
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8200/v1/sys/health?uninitcode=200&sealedcode=200"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

# Secrets √† cr√©er √† la main avant d√©ploiement
secrets:
  consul-encrypt-key:
    external: true

# R√©seau chiffr√© Swarm externe d√©j√† cr√©√© (overlay)
networks:
  secret:
    name: secret
    external: true
</code></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Bloc swarm_vault_agent.yml -->
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-vaultAgent" aria-expanded="false"
                                    aria-controls="panelsStayOpen-vaultAgent">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">swarm_vault_agent.yml</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-vaultAgent" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Stack 2 ‚Äî Vault Agent :</strong>
                                    <p>
                                        Cette stack d√©ploie le <code>vault_agent</code>, un client Vault qui s'ex√©cute
                                        sur tous les n≈ìuds (mode <code>global</code>). Il s'authentifie via un AppRole
                                        s√©curis√© (avec <code>role_id</code> et <code>secret_id</code>) et r√©cup√®re les
                                        secrets, en particulier les certificats, qu'il √©crit directement dans les
                                        emplacements syst√®me des NAS Synology.
                                    </p>

                                    <strong>Pourquoi deux stacks ?</strong>
                                    <ul>
                                        <li><strong>Premi√®re stack :</strong> d√©ploie le backend <code>consul</code> +
                                            <code>vault</code>, n√©cessaire pour initialiser et faire tourner Vault.
                                        </li>
                                        <li><strong>Deuxi√®me stack :</strong> d√©ploie l'agent Vault qui consomme les
                                            secrets, il ne peut √™tre lanc√© qu'apr√®s que Vault est initialis√© et
                                            d√©verrouill√©.</li>
                                    </ul>

                                    <div class="alert alert-info">
                                        <strong>Note de s√©curit√© :</strong> Le Vault Agent requiert des droits √©lev√©s
                                        (<code>root</code>), des capacit√©s sp√©cifiques (<code>SYS_CHROOT</code>,
                                        <code>IPC_LOCK</code>) et acc√®s en lecture sur le syst√®me h√¥te. Cela permet
                                        notamment d'appliquer les certificats et de red√©marrer les services (nginx
                                        notamment) sur le NAS.
                                    </div>

                                    <strong>Explications des options cl√©s :</strong>
                                    <ul>
                                        <li><code>user: root</code> pour avoir tous les droits n√©cessaires.</li>
                                        <li><code>cap_add: IPC_LOCK</code> pour verrouiller la m√©moire et prot√©ger les
                                            secrets.</li>
                                        <li><code>cap_add: SYS_CHROOT</code> pour utiliser chroot et acc√©der au syst√®me h√¥te,
                                        notamment pour red√©marrer des services.</li>
                                        <li><code>volumes</code> importants :
                                            <ul>
                                                <li>Les configs agent et templates de certificats.</li>
                                                <li>L'emplacement des certificats Synology (avec RW).</li>
                                                <li>L'acc√®s au syst√®me h√¥te en lecture pour contr√¥le et actions.</li>
                                            </ul>
                                        </li>
                                        <li><code>secrets</code> : injection des <code>role_id</code> et
                                            <code>secret_id</code> via secrets Docker Swarm.
                                        </li>
                                        <li><code>deploy.mode: global</code> pour garantir la pr√©sence d'un agent par
                                            n≈ìud.</li>
                                    </ul>

                                    <p>
                                        Voici le fichier <code>swarm_vault_agent.yml</code> complet avec commentaires
                                        pour bien comprendre chaque partie :
                                    </p>

                                    <pre class="bg-dark text-light p-3 rounded mh-100" style="white-space: pre-wrap;">
<code class="language-yaml">version: "3.8"

services:
  vault_agent:
    image: hashicorp/vault:1.15
    user: root
    cap_add:
      # Protection m√©moire pour √©viter le swap des secrets
      - IPC_LOCK
      # Permet d'utiliser chroot pour acc√©der au syst√®me h√¥te (ex: pour red√©marrer nginx)
      - SYS_CHROOT 
    volumes:
      # Configuration de l'agent Vault
      - /volume1/docker/secret/vault_agent/config:/vault/config
      # Templates des certificats TLS √† g√©n√©rer
      - /volume1/docker/secret/vault_agent/templates:/vault/templates
      # Emplacement des certificats Synology, acc√®s lecture/√©criture
      - /usr/syno/etc/certificate/_archive:/certs:rw
      # Synchronisation horaire avec l'h√¥te
      - /etc/localtime:/etc/localtime:ro
      # Acc√®s en lecture au syst√®me h√¥te pour contr√¥le et red√©marrage
      - /:/host:ro
    secrets:
      # Credentials AppRole Vault inject√©s via secrets Swarm
      - vault-role-id
      - vault-secret-id
    command: sh -c "vault agent -config=/vault/config/agent.hcl"
    networks:
      - secret
    deploy:
      # Lancement d'un agent sur chaque n≈ìud du Swarm
      mode: global
      restart_policy:
        condition: any
        delay: 30s
        max_attempts: 20
        window: 600s

# Secrets AppRole √† cr√©er manuellement avant d√©ploiement
secrets:
  vault-role-id:
    external: true
  vault-secret-id:
    external: true

# R√©seau chiffr√© overlay Swarm partag√© entre services
networks:
  secret:
    name: secret
    external: true
</code></pre>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
                                    aria-controls="panelsStayOpen-collapseTwo">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">consul</li>
                                        <li class="breadcrumb-item">config</li>
                                        <li class="breadcrumb-item">server.hcl</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Le server.hcl : Quand la simplicit√© rencontre l'efficacit√©</strong>

                                    <p>Ce fichier <code>server.hcl</code> est probablement le plus court de notre stack,
                                        mais ne t'y trompes pas ce petit fichier optimise silencieusement les
                                        performances
                                        de Consul.</p>

                                    <strong>Le multiplicateur Raft :</strong>
                                    <p>
                                        Consul utilise l'algorithme Raft pour maintenir la coh√©rence des donn√©es dans le
                                        cluster. Ce multiplicateur est un facteur d'√©chelle qui affecte directement les
                                        timeouts de HeartbeatTimeout, ElectionTimeout et LeaderLeaseTimeout.
                                    </p>


                                    <p>
                                        <code>raft_multiplier = 1</code>
                                        <span>Configuration haute performance recommand√©e pour la
                                            production. HashiCorp recommande de configurer ce param√®tre √† 1 en
                                            production
                                            pour permettre aux serveurs Consul de d√©tecter rapidement une d√©faillance du
                                            leader et de terminer les √©lections de leader beaucoup plus
                                            rapidement.</span>
                                    </p>

                                    <div class="alert alert-success">
                                        <strong>Pourquoi raft_multiplier = 1 ?</strong>
                                        <ul class="mb-0 mt-2">
                                            <li><strong>Performance optimale :</strong> D√©tection rapide des
                                                d√©faillances et
                                                √©lections de leader plus rapides</li>
                                            <li><strong>R√©seau local :</strong> Convient parfaitement aux environnements
                                                avec faible latence r√©seau</li>
                                            <li><strong>Production ready :</strong> Configuration recommand√©e par
                                                HashiCorp
                                            </li>
                                            <li><strong>Timeouts optimis√©s :</strong> HeartbeatTimeout=1000ms,
                                                ElectionTimeout=1000ms, LeaderLeaseTimeout=500ms</li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è Attention :</strong>
                                        <p class="mb-0">
                                            La valeur par d√©faut de Consul est 5 (pour des instances t2.micro AWS), mais
                                            cela rend la d√©tection de d√©faillance et les √©lections beaucoup plus lentes.
                                            Dans notre environnement NAS local, <code>1</code> est le choix optimal !
                                        </p>
                                    </div>

                                    <div class="alert alert-primary">
                                        <strong>üìñ Documentation officielle</strong>
                                        <p class="mb-0">
                                            Pour plus de d√©tails sur les param√®tres de performance Consul, consultez la
                                            <a href="https://developer.hashicorp.com/consul/docs/reference/architecture/server"
                                                target="_blank" class="text-decoration-none">documentation HashiCorp sur
                                                les
                                                exigences serveur</a>.
                                        </p>
                                    </div>

                                    <p>En r√©sum√©, ce fichier fait exactement ce qu'il faut : il configure Consul pour
                                        qu'il
                                        fonctionne avec les performances optimales recommand√©es par HashiCorp.
                                        Contrairement
                                        aux id√©es re√ßues, la valeur <code>1</code> n'est pas la "configuration par
                                        d√©faut"
                                        mais bien la <strong>configuration haute performance</strong> pour la production
                                        !
                                    </p>
                                    <pre class="bg-dark text-light p-3 rounded mh-100">
<code class="language-hcl"># Configuration de performance pour Consul
performance {
  # Multiplicateur Raft pour ajuster les timeouts
  # Valeur 1 = configuration pour la production
  raft_multiplier = 1
}</code>
</pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
                                    aria-controls="panelsStayOpen-collapseThree">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">consul</li>
                                        <li class="breadcrumb-item">config</li>
                                        <li class="breadcrumb-item">start_consul.sh</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Le start_consul.sh : Quand Docker rencontre l'auto-configuration</strong>

                                    <p>Le script shell <code>start_consul.sh</code> fait le travail ingrat que personne
                                        ne
                                        veut faire : r√©cup√©rer
                                        automatiquement l'IP du conteneur et d√©marrer Consul avec les bons param√®tres.
                                        Parce
                                        que personne n'a envie de faire du <code>docker inspect</code> √† chaque
                                        red√©marrage
                                        !</p>

                                    <strong>üîç D√©tection automatique de l'IP</strong>
                                    <p>
                                        <code>IP=$(getent hosts $HOSTNAME | awk '{ print $1 }')</code> - Cette ligne
                                        magique r√©cup√®re l'IP du conteneur dans le r√©seau Docker. Plus besoin de deviner
                                        ou de hardcoder une IP !
                                    </p>

                                    <strong>üöÄ Param√®tres de d√©marrage Consul :</strong>
                                    <ul>
                                        <li><code>-server</code> Mode serveur (pas agent)</li>
                                        <li><code>-ui </code> Active l'interface web</li>
                                        <li><code>-client="0.0.0.0"</code> √âcoute sur toutes les
                                            interfaces</li>
                                        <li><code>-bind="$IP"</code> IP d'√©coute pour
                                            le cluster</li>
                                        <li><code>-advertise="$IP"</code> IP annonc√©e aux autres
                                            n≈ìuds</li>
                                    </ul>

                                    <strong>‚ö†Ô∏è Configuration cluster mono-n≈ìud :</strong>
                                    <p>
                                        <code>-bootstrap-expect=1</code> indique √† Consul qu'il n'y aura qu'un seul
                                        serveur dans le cluster. Parfait pour notre NAS, mais attention √† ne pas
                                        utiliser cette configuration pour un vrai cluster distribu√© !
                                    </p>

                                    <strong>üìÅ R√©pertoires et logs :</strong>
                                    <ul>
                                        <li><code>-data-dir="/consul/data"</code> - Stockage persistant des donn√©es</li>
                                        <li><code>-config-dir="/consul/config"</code> - R√©pertoire de configuration</li>
                                        <li><code>-log-level="INFO"</code> - Niveau de logs √©quilibr√©</li>
                                        <li><code>-disable-host-node-id=true</code> - D√©sactive l'ID bas√© sur l'h√¥te
                                            (recommand√© pour Docker)</li>
                                    </ul>

                                    <p>Le <code>exec</code> final remplace le processus shell par Consul, permettant une
                                        gestion propre des signaux Docker (<code>PID 1</code>). C'est la diff√©rence
                                        entre un
                                        script amateur et un
                                        script professionnel !</p>

                                    <div class="alert alert-success">
                                        <strong>üí° Pourquoi ce script ?</strong>
                                        <p class="mb-0">
                                            Docker attribue des IPs dynamiques aux conteneurs. Ce script √©vite les
                                            configurations statiques fragiles et s'adapte automatiquement √†
                                            l'environnement
                                            Docker Swarm, m√™me si l'IP change.
                                        </p>
                                    </div>
                                    <pre class="bg-dark text-light p-3 rounded mh-100">
<code class="language-shell">#!/bin/sh

# Retrieves the IP on the 'secret' network (adapt the interface name if needed)
IP=$(getent hosts $HOSTNAME | awk '{ print $1 }')

echo "Starting Consul with IP: $IP"

# Read encryption key in secret Docker Swarm
if [ -f /run/secrets/consul-encrypt-key ]; then
    ENCRYPT_KEY=$(cat $CONSUL_ENCRYPT_KEY_FILE)
    echo "Encrypt key load from secret"
else
    echo "ERROR: Secret consul-encrypt-key not found!"
    exit 1
fi


exec consul agent \
  -server \
  -ui \
  -client="0.0.0.0" \
  -bind="$IP" \
  -advertise="$IP" \
  -bootstrap-expect=1 \
  -data-dir="/consul/data" \
  -config-dir="/consul/config" \
  -log-level="INFO" \
  -encrypt="$ENCRYPT_KEY" \
  -datacenter="$CONSUL_DATACENTER" \
  -domain="$CONSUL_DOMAIN" \
  -node="$CONSUL_NODE_NAME" \
  -disable-host-node-id=true</code>
</pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapseFour" aria-expanded="false"
                                    aria-controls="panelsStayOpen-collapseFour">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">vault</li>
                                        <li class="breadcrumb-item">config</li>
                                        <li class="breadcrumb-item">vault.hcl</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-collapseFour" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Le vault.hcl : Configuration du coffre-fort num√©rique</strong>

                                    <p>Ce fichier <code>vault.hcl</code> est le cerveau de notre Vault. Contrairement au
                                        server.hcl minimaliste, celui-ci contient tous les param√®tres essentiels pour
                                        faire
                                        tourner notre coffre-fort en mode production.</p>

                                    <strong>Interface Web et Backend de stockage</strong>
                                    <p>
                                        <code>ui = true</code>
                                        Active l'interface web de Vault, parce que personne n'a envie de tout faire en
                                        ligne de commande (m√™me si c'est possible).
                                    </p>

                                    <strong>Le stockage Consul : Mariage parfait</strong>
                                    <p>
                                        <code>storage "consul"</code>
                                        <span>Vault utilise Consul comme backend de stockage. C'est du
                                            mariage arrang√© qui fonctionne parfaitement : Consul g√®re la persistance,
                                            Vault
                                            g√®re la s√©curit√©. Pour une solution encore plus simple, il est tout √† fait
                                            possible de se passer compl√®tement de Consul et de configurer Vault pour
                                            qu'il
                                            stocke ses donn√©es directement sur l'h√¥te, via un backend comme
                                            <code>file.</code></span>
                                    </p>

                                    <strong>Param√®tres de stockage Consul :</strong>
                                    <ul>
                                        <li><code>address = "consul:8500"</code> Adresse du serveur Consul (nom
                                            Docker)</li>
                                        <li><code>path = "vault/"</code> Chemin de stockage dans le KV store
                                            Consul</li>
                                        <li><code>scheme = "http"</code> Protocole HTTP (r√©seau interne s√©curis√©)
                                        </li>
                                        <li><code>session_ttl = "15s"</code> Dur√©e de vie des sessions Consul</li>
                                        <li><code>lock_wait_time = "15s"</code> Temps d'attente pour les verrous
                                        </li>
                                    </ul>

                                    <strong>Listener TCP : L'oreille de Vault</strong>
                                    <p>
                                        <code>listener "tcp"</code>
                                        <span>Configuration du listener HTTP sur le port 8200 avec TLS
                                            d√©sactiv√© car g√©r√© par le reverse proxy Synology. Le chiffrement ne sera pas
                                            strictement de bout en bout, puisque c'est le reverse proxy qui termine la
                                            connexion TLS. Cependant, comme ce proxy est h√©berg√© sur le m√™me h√¥te que
                                            Vault,
                                            le trafic non chiffr√© entre le proxy et Vault ne transite que sur
                                            l'interface
                                            localhost.
                                        </span>
                                    </p>

                                    <div class="alert alert-success">
                                        <strong>üîê Note de s√©curit√© :</strong>
                                        <p class="mb-0">Ce compromis est g√©n√©ralement acceptable dans un environnement
                                            contr√¥l√©, tant que
                                            l'h√¥te est correctement s√©curis√©. Toutefois, pour une configuration de
                                            production √† haute sensibilit√©, il est recommand√© d'activer TLS directement
                                            dans
                                            Vault afin d'assurer un chiffrement complet, m√™me en local.
                                        </p>
                                    </div>

                                    <div class="alert alert-primary">
                                        <strong>üß∞ Caisse √† Outils </strong>
                                        <p class="mb-0">
                                            Pour plus de d√©tails sur le fonctionnement du mTLS consultez <a
                                                href="../tool-box/mtls.html" class="text-decoration-none">l'article
                                                ici</a>.
                                        </p>
                                    </div>

                                    <strong>Configuration X-Forwarded-For :</strong>
                                    <p>
                                        Les param√®tres <code>x_forwarded_for_*</code> permettent √† Vault de r√©cup√©rer
                                        les vraies adresses IP des clients qui passent par le reverse proxy. Essentiel
                                        pour l'audit et la s√©curit√© !
                                    </p>


                                    <strong>Configuration des baux (leases) :</strong>
                                    <ul>
                                        <li><code>default_lease_ttl = "168h"</code> 7 jours par d√©faut pour les
                                            secrets</li>
                                        <li><code>max_lease_ttl = "720h"</code> 30 jours maximum, parce qu'il faut
                                            bien une limite</li>
                                        <li><code>api_addr = "https://vault.internal"</code> URL publique via le
                                            reverse proxy</li>
                                    </ul>

                                    <strong>Logs et monitoring :</strong>
                                    <p>
                                        <code>log_level = "INFO"</code> et
                                        <code>log_format = "standard"</code>
                                        Configuration optimis√©e pour Synology avec logs lisibles et niveau d'information
                                        appropri√©.
                                    </p>
                                    <strong>üîß D√©tail technique :</strong>
                                    <p>
                                        <code>disable_mlock = false</code>
                                        <span>
                                            Active le verrouillage m√©moire (<code>mlock</code>) pour √©viter que des
                                            secrets
                                            ne se retrouvent
                                            dans le swap. C'est la bonne pratique recommand√©e par HashiCorp pour une
                                            instance s√©rieuse de Vault.
                                            Par d√©faut, les containers Docker ne peuvent pas utiliser
                                            <code>mlock()</code>,
                                            mais ici on a ajout√©
                                            la capacit√© <code>IPC_LOCK</code> (merci <code>cap_add</code>), ce qui
                                            permet √†
                                            Vault de prot√©ger ses
                                            secrets correctement, m√™me en container.
                                            Bref, si tu veux dormir tranquille, tu laisses √ßa √† <code>false</code> (oui,
                                            c'est contre-intuitif,
                                            mais c'est bien <strong>false</strong> qui signifie : "je <em>n</em>'emp√™che
                                            pas
                                            Vault d'utiliser
                                            <code>mlock()</code>"). üõ°Ô∏è
                                        </span>
                                    </p>

                                    <p>
                                        <code>disable_clustering = true</code>
                                        <span>D√©sactive le clustering Vault car nous n'avons qu'un seul
                                            n≈ìud. Simplifie la configuration.</span>
                                    </p>
                                    <pre class="bg-dark text-light p-3 rounded mh-100">
<code class="language-hcl"># Active l'interface web de Vault
ui = true

# Configuration du backend de stockage Consul
storage "consul" {
  # Adresse du serveur Consul
  address = "consul:8500"
  # Chemin de stockage dans Consul
  path    = "vault/"
  # Protocole (HTTP car r√©seau interne)
  scheme  = "http"
  
  # Configuration de session Consul
  # Dur√©e de vie des sessions
  session_ttl = "15s"
  # Temps d'attente pour les verrous
  lock_wait_time = "15s"
}

# Listener HTTP - TLS g√©r√© par le reverse proxy Synology
listener "tcp" {
  address     = "0.0.0.0:8200"
  # TLS d√©sactiv√© (g√©r√© par le reverse proxy)
  tls_disable = 1
  
  # Configuration pour les en-t√™tes X-Forwarded-For
  x_forwarded_for_authorized_addrs = ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
  x_forwarded_for_hop_skips = 0
  x_forwarded_for_reject_not_authorized = false
  x_forwarded_for_reject_not_present = false
}

# Configuration pour le reverse proxy HTTPS
# URL publique via reverse proxy
api_addr = "https://vault.internal"
disable_clustering = true

# Activer mlock pour √©viter le swap sur l'h√¥te
disable_mlock = false

# Configuration des logs
log_level = "INFO"
# Format lisible pour Synology
log_format = "standard"

# Configuration des baux (leases)
# 7 jours par d√©faut
default_lease_ttl = "168h"
# 30 jours maximum
max_lease_ttl = "720h"</code>
</pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapseFive" aria-expanded="false"
                                    aria-controls="panelsStayOpen-collapseFive">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">vault-agent</li>
                                        <li class="breadcrumb-item">config</li>
                                        <li class="breadcrumb-item">agent.hcl</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-collapseFive" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Le agent.hcl : Le chef d'orchestre de l'automatisation</strong>

                                    <p>Le <code>agent.hcl</code> configure Vault-Agent, le composant qui transforme
                                        notre infrastructure en v√©ritable usine √† certificats automatis√©e. C'est lui qui
                                        se
                                        connecte √† Vault,
                                        s'authentifie tout seul comme un grand, et g√©n√®re nos certificats SSL sans
                                        intervention humaine.</p>

                                    <strong>Configuration de connexion √† Vault</strong>
                                    <p>
                                        La section <code>vault</code> d√©finit comment l'agent se connecte au serveur
                                        Vault avec une strat√©gie de retry robuste (5 tentatives) pour g√©rer les
                                        red√©marrages et les probl√®mes r√©seau temporaires. Chaque tentative est plus
                                        longue que la pr√©c√©dente afin de laisser le temps au Vault de d√©marrer.
                                    </p>

                                    <strong>Authentification automatique :</strong>
                                    <p>
                                        <span>L'agent utilise la m√©thode AppRole pour s'authentifier
                                            automatiquement aupr√®s de Vault.</span>
                                    </p>

                                    <div class="alert alert-success">
                                        <strong>Pourquoi AppRole ?</strong>
                                        <ul class="mb-0">
                                            <li><strong>S√©curit√© :</strong> Les paires sont r√©vocables et assignables √†
                                                des
                                                politiques de gestion plus fines.</li>
                                            <li><strong>Automatisation :</strong> Pas besoin d'intervention ou
                                                d'interaction
                                                humaine. C'est fait pour les scripts, les jobs ou les agents !</li>
                                            <li><strong>Rotation :</strong> Les secret_id peuvent √™tre renouvel√©s
                                                automatiquement.</li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-warning">
                                        <p class="mb-0">
                                            <code>remove_secret_id_file_after_reading = false</code>
                                        </p>
                                        <span>Cette option importante permet de conserver le secret_id en m√©moire afin
                                            d'√©viter des r√©authentifications constantes. Dans notre environnement
                                            Docker,
                                            cela apporte plus de stabilit√©. Pas d'inqui√©tude c√¥t√© s√©curit√© : notre agent
                                            ne
                                            l'utilise que pour r√©cup√©rer un token, et c'est ce token qui servira ensuite
                                            √†
                                            toutes les op√©rations sur les certificats.
                                        </span>
                                    </div>

                                    <strong>Template magic :</strong>
                                    <p>
                                        La section <code>template</code> est le c≈ìur de l'automatisation. Elle surveille
                                        le template <code>/vault/templates/cert.tpl</code> et g√©n√®re automatiquement les
                                        certificats.
                                    </p>

                                    <div class="alert alert-info">
                                        <strong>Important √† savoir</strong>
                                        <ul class="mb-0">
                                            <li><code>writeToFile</code> √©crit syst√©matiquement les fichiers √† chaque
                                                rendu
                                                du template, <strong>m√™me si le contenu n'a pas chang√©</strong>.</li>
                                            <li>Le fichier <code>destination</code> est quant √† lui <strong>compar√©
                                                    avant
                                                    √©criture</strong> : Vault Agent ne le r√©√©crit que si son contenu
                                                diff√®re
                                                du pr√©c√©dent.</li>
                                            <li>Le script <code>command</code> (ex : red√©marrage d'un service) est
                                                d√©clench√©
                                                <strong>uniquement si le fichier <code>destination</code> est mis √†
                                                    jour</strong>.
                                            </li>
                                            <li>C'est pourquoi il est recommand√© de regrouper dans un seul fichier
                                                <code>destination</code> tous les √©l√©ments critiques (certificat, cl√©,
                                                CA
                                                concat√©n√©s), pour √©viter des red√©marrages inutiles.
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-success">
                                        <strong>Le workflow automatique</strong>
                                        <ul class="mb-0">
                                            <li>
                                                <strong>Surveillance</strong>
                                                <span>L'agent surveille en permanence la validit√© du
                                                    certificat (en interne).</span>
                                            </li>

                                            <li>
                                                <strong>G√©n√©ration</strong>
                                                <span>Quand le certificat approche de l'expiration, le
                                                    template est ex√©cut√© (√† 90% du TTL ou lors d'un red√©marrage de
                                                    l'agent).</span>
                                            </li>

                                            <li>
                                                <strong>D√©ploiement</strong>
                                                <span>Le script <code>restart_service.sh</code> est
                                                    automatiquement ex√©cut√© <strong>uniquement si le fichier
                                                        <code>destination</code> a chang√©</strong>.<br>
                                                    Cela √©vite de red√©marrer le service inutilement si seuls les
                                                    fichiers
                                                    g√©n√©r√©s par <code>writeToFile</code> ont √©t√© √©crits mais sans
                                                    modification r√©elle du certificat.
                                                </span>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-info">
                                        <strong>Pro tip</strong>
                                        <p>Il est tout √† fait possible de d√©finir plusieurs sections template dans le
                                            fichier de configuration de Vault-Agent. Chacune peut cibler un certificat
                                            diff√©rent, un chemin sp√©cifique dans Vault, et avoir son propre script de
                                            d√©marrage (<code>command</code>) associ√©.</p>
                                        <p class="mb-0">
                                            Cela te permet de g√©n√©rer autant de certificats que n√©cessaire, chacun avec
                                            des
                                            param√®tres distincts (chemins, r√¥les, SAN, TTL, etc.). C'est
                                            particuli√®rement
                                            utile si tu dois √©quiper plusieurs services, applications ou interfaces
                                            r√©seau
                                            avec des certificats diff√©rents, tout en gardant une configuration
                                            centralis√©e
                                            et coh√©rente.
                                        </p>
                                    </div>
                                    <div class="alert alert-info">
                                        <p class="mb-0">
                                            <strong>Astuce suppl√©mentaire</strong><br>
                                            Si tu utilises plusieurs templates avec chacun leur propre
                                            <code>destination</code> et <code>command</code>, veille √† bien g√©rer
                                            l'ordre
                                            des red√©marrages pour √©viter des interruptions partielles ou en double.
                                        </p>
                                    </div>

                                    <strong>üîß D√©tail technique :</strong>
                                    <p>
                                        <code>disable_mlock = false</code>
                                        <span>
                                            Active le verrouillage m√©moire (<code>mlock</code>) pour √©viter que des
                                            secrets
                                            ne se retrouvent
                                            dans le swap. C'est la bonne pratique recommand√©e par HashiCorp pour une
                                            instance s√©rieuse de Vault.
                                            Par d√©faut, les containers Docker ne peuvent pas utiliser
                                            <code>mlock()</code>,
                                            mais ici on a ajout√©
                                            la capacit√© <code>IPC_LOCK</code> (merci <code>cap_add</code>), ce qui
                                            permet √†
                                            Vault de prot√©ger ses
                                            secrets correctement, m√™me en container.
                                            Bref, si tu veux dormir tranquille, tu laisses √ßa √† <code>false</code> (oui,
                                            c'est contre-intuitif,
                                            mais c'est bien <strong>false</strong> qui signifie : "je <em>n</em>'emp√™che
                                            pas
                                            Vault d'utiliser
                                            <code>mlock()</code>"). üõ°Ô∏è
                                        </span>
                                    </p>

                                    <p>En r√©sum√©, ce fichier transforme Vault-Agent en v√©ritable assistant personnel qui
                                        g√®re tout le cycle de vie des certificats SSL : authentification, g√©n√©ration,
                                        d√©ploiement et red√©marrage des services. Plus besoin de se lever √† 3h du matin
                                        parce
                                        qu'un certificat a expir√© !</p>

                                    <pre class="bg-dark text-light p-3 rounded mh-100"><code class="language-hcl"># Configuration de connexion √† Vault
vault {
  address = "http://vault:8200"
  retry {
    # Nombre de tentatives de reconnexion
    num_retries = 5
  }
}

# Authentification automatique via AppRole
auto_auth {
  method "approle" {
    mount_path = "auth/approle"
    config = {
      # Fichiers contenant les identifiants AppRole
      role_id_file_path   = "/run/secrets/vault_role_id"
      secret_id_file_path = "/run/secrets/vault_secret_id"
      # Garde le secret_id pour √©viter les re-authentifications
      remove_secret_id_file_after_reading = false
    }
  }
}

# Activer mlock pour √©viter le swap sur l'h√¥te
disable_mlock = true

# Template pour g√©n√©rer les certificats SSL
template {
  # Template source
  source      = "/vault/templates/cert.tpl"
  # Fichier de sortie
  destination = "/certs/myCert/all-certs"
  # Script post-g√©n√©ration
  command     = "/bin/sh /vault/config/restart_service.sh"
}
</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapseSix" aria-expanded="false"
                                    aria-controls="panelsStayOpen-collapseSix">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">secret</li>
                                        <li class="breadcrumb-item">vault-agent</li>
                                        <li class="breadcrumb-item">config</li>
                                        <li class="breadcrumb-item">restart_service.sh</li>
                                    </ol>
                                </button>
                            </h3>
                            <div id="panelsStayOpen-collapseSix" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <strong>Le <code>restart_service.sh</code> : Quand Docker rencontre
                                        Synology</strong>

                                    <p>Le script <code>restart_service.sh</code> fait le lien entre notre conteneur
                                        Vault
                                        Agent
                                        et le syst√®me h√¥te Synology. Il permet de red√©marrer nginx (ou d'autres
                                        services)
                                        automatiquement apr√®s la mise √† jour des certificats, √©vitant ainsi toute
                                        intervention manuelle.</p>

                                    <div class="alert alert-info">
                                        <strong>Le d√©fi technique :</strong>
                                        <p class="mb-0">Comment red√©marrer un service syst√®me depuis un conteneur Docker
                                            ?
                                            La solution repose sur :</p>
                                        <ul>
                                            <li><code>chroot</code> pour basculer la racine du syst√®me de fichiers vers
                                                le
                                                syst√®me h√¥te</li>
                                            <li>Un volume Docker <code>/:/host:ro</code> mont√© en lecture seule,
                                                exposant le
                                                syst√®me Synology √† l'int√©rieur du conteneur</li>
                                        </ul>
                                        <p><code>chroot /host</code> ¬´ maquille ¬ª le conteneur en syst√®me h√¥te, lui
                                            permettant d'ex√©cuter les commandes syst√®me du Synology.</p>
                                        <p class="mb-0">La commande <code>synosystemctl restart nginx</code> est
                                            sp√©cifique au DSM de
                                            Synology : c'est l'√©quivalent de <code>systemctl</code> sur Linux classique.
                                        </p>
                                    </div>

                                    <div class="alert alert-success">
                                        <strong>Pourquoi cette approche ?</strong>
                                        <ul class="mb-0 mt-2">
                                            <li><strong>S√©curit√© :</strong> Le volume est mont√© en lecture seule
                                                (<code>:ro</code>) pour limiter les risques</li>
                                            <li><strong>Isolation :</strong> Le conteneur n'a acc√®s qu'√† ce dont il a
                                                besoin
                                            </li>
                                            <li><strong>Automatisation :</strong> Le red√©marrage se fait sans
                                                intervention
                                                humaine</li>
                                            <li><strong>Simplicit√© :</strong> Pas besoin de services additionnels ou de
                                                m√©canismes complexes de communication inter-processus</li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è Pr√©requis importants :</strong>
                                        <p class="mb-0">
                                            Pour que <code>chroot</code> fonctionne correctement, le conteneur Vault
                                            Agent
                                            doit √™tre lanc√© avec l'utilisateur <code>root</code> et la capability
                                            <code>SYS_CHROOT</code> activ√©e.
                                            <br>
                                            V√©rifie aussi que le montage du volume vers <code>/host</code> est
                                            correctement
                                            configur√©.
                                        </p>
                                    </div>

                                    <div class="alert alert-secondary">
                                        <p><strong>üîß Alternatives possibles :</strong></p>
                                        <strong>Red√©marrage manuel</strong>
                                        <ul>
                                            <li>N√©cessite une intervention humaine</li>
                                            <li>Peu adapt√© √† l'automatisation</li>
                                        </ul>

                                        <strong>Fichier de signal sur volume partag√©</strong>
                                        <ul>
                                            <li>Un fichier flag √©crit par le conteneur, surveill√© par un cron ou un
                                                service
                                                h√¥te</li>
                                            <li>Complexit√© et risques d'incoh√©rence li√©s √† la synchronisation</li>
                                        </ul>

                                        <strong>Communication via socket Unix ou API</strong>
                                        <ul class=" mb-0">
                                            <li>Implique un processus √©couteur sur l'h√¥te</li>
                                            <li>Complexit√© accrue de mise en place</li>
                                        </ul>
                                    </div>

                                    <p>En r√©sum√©, ce script court et simple est une solution pragmatique et efficace
                                        pour
                                        relier Vault Agent et la gestion des services syst√®me sous Synology.</p>

                                    <pre class="bg-dark text-light p-3 rounded mh-100">
<code class="language-shell">#!/bin/bash

# Script de red√©marrage automatique des services apr√®s mise √† jour des certificats
# Utilis√© par Vault Agent via la directive `command` dans le template

set -euo pipefail

NGINX_RESTART_CMD="chroot /host /usr/syno/bin/synosystemctl restart nginx"

echo "Certificates deployed"

echo "Restarting nginx..."
if $NGINX_RESTART_CMD; then
   echo "Nginx restarted successfully"
else
   echo "Error while restarting nginx"
   exit 1
fi

echo "Deployment completed successfully"</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-item">
                                <h3 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#panelsStayOpen-collapseSeven" aria-expanded="false"
                                        aria-controls="panelsStayOpen-collapseSeven">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item">secret</li>
                                            <li class="breadcrumb-item">vault-agent</li>
                                            <li class="breadcrumb-item">templates</li>
                                            <li class="breadcrumb-item">cert.tpl</li>
                                        </ol>
                                    </button>
                                </h3>
                                <div id="panelsStayOpen-collapseSeven" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <strong>Le cert.tpl : La magie des templates Vault-Agent</strong>

                                        <p>Ce template est le c≈ìur de notre syst√®me de g√©n√©ration automatique de
                                            certificats. Il
                                            utilise la syntaxe des templates Vault-Agent pour g√©n√©rer des certificats
                                            SSL/TLS et
                                            les d√©ployer automatiquement dans l'architecture Synology.</p>

                                        <strong>Anatomie du template :</strong>
                                        <p>
                                            Le template utilise la fonction <code>pkiCert</code> de Vault-Agent pour
                                            g√©n√©rer
                                            un certificat via l'API PKI de Vault (que l'on va cr√©er en Phase 3), puis
                                            d√©ploie les diff√©rents composants
                                            dans les fichiers requis par Synology. Tu peux √©crire tous les certificats
                                            que
                                            tu souhaites et m√™me faire plusieurs templates du moment qu'ils sont
                                            d√©clar√©s
                                            dans
                                            le <code>agent.hcl</code>.
                                        </p>

                                        <p>
                                            <strong>Param√®tres de g√©n√©ration du certificat :</strong>
                                        <ul class="mb-0 mt-2">
                                            <li><code>pki/issue/internal-server</code> : Chemin
                                                vers le r√¥le PKI configur√© dans Vault.</li>
                                            <li><code>common_name=nas.internal</code> : Nom
                                                principal du certificat (CN).</li>
                                            <li><code>alt_names=consul.internal,vault.internal</code>
                                                : Noms alternatifs (SAN).</li>
                                            <li><code>ttl=2160h</code> : Dur√©e de vie du certificat
                                                (90 jours).</li>
                                        </ul>
                                        </p>

                                        <div class="alert alert-warning">
                                            <code>{{ .Cert }}{{ .CA }}{{ .Key }}</code>
                                            <p>
                                                Cette ligne concat√®ne la cl√© priv√©e, le certificat et la cha√Æne
                                                d'autorit√©
                                                dans un seul fichier nomm√© <code>all-certs</code>, utilis√© par Vault
                                                Agent pour suivre l'√©tat du certificat.
                                            </p>
                                            <p class="mb-0">
                                                Supprimer ce fichier sur l'h√¥te ne force pas automatiquement un
                                                renouvellement imm√©diat. Toutefois, cette suppression peut √™tre d√©tect√©e
                                                par
                                                Vault Agent si celui-ci est red√©marr√© ou si son cache local est effac√©,
                                                ce
                                                qui d√©clenche alors la r√©g√©n√©ration des certificats. Cette manipulation
                                                est
                                                utile si tu souhaites appliquer des modifications comme ajouter des SAN,
                                                changer la dur√©e de vie (TTL) ou modifier d'autres param√®tres du
                                                certificat.
                                            </p>
                                        </div>

                                        <strong>D√©ploiement automatique des fichiers :</strong>
                                        <p>
                                            Le template utilise la fonction <code>writeToFile</code> pour cr√©er
                                            automatiquement les fichiers n√©cessaires avec les bonnes permissions dans
                                            l'archive des certificats Synology.
                                        </p>

                                        <div class="alert alert-success">
                                            <strong>Structure des fichiers g√©n√©r√©s :</strong>
                                            <ul class="mb-0 mt-2">
                                                <li><code>privkey.pem</code> : Cl√© priv√©e (permissions 0600,
                                                    propri√©taire
                                                    root :
                                                    format attendu par Synology)
                                                </li>
                                                <li><code>cert.pem</code> : Certificat seul (permissions 0644,
                                                    propri√©taire
                                                    root : format attendu par Synology)</li>
                                                <li><code>fullchain.pem</code> : Certificat + CA (permissions 0644,
                                                    propri√©taire
                                                    root : format attendu par Synology)</li>
                                                <li><code>all-certs</code> : Fichier principal contenant tout (format
                                                    attendu
                                                    par Vault)</li>
                                            </ul>
                                        </div>

                                        <div class="alert alert-info">
                                            <strong>üîÑ Processus automatique :</strong>
                                            <p class="mb-0">
                                                √Ä chaque ex√©cution du template (renouvellement du certificat),
                                                Vault-Agent
                                                g√©n√®re
                                                un nouveau certificat, l'√©crit dans les fichiers appropri√©s, puis
                                                d√©clenche
                                                le
                                                script <code>restart_service.sh</code> pour red√©marrer nginx et
                                                appliquer
                                                les
                                                nouveaux certificats.
                                            </p>
                                        </div>

                                        <p>Ce template illustre parfaitement la puissance de Vault-Agent : une seule
                                            configuration qui g√®re g√©n√©ration, d√©ploiement et rechargement automatique
                                            des
                                            certificats. Plus besoin de se soucier des renouvellements manuels !</p>
                                        <pre class="bg-dark text-light p-3 rounded mh-100">
<code class="language-hcl">{{- with pkiCert "pki/issue/internal-server" "common_name=nas.internal" "alt_names=consul.internal,vault.internal" "ttl=2160h" -}}
{{ .Cert }}{{ .CA }}{{ .Key }}
{{- .Key | writeToFile "/certs/myCert/privkey.pem" "root" "root" "0600" -}}
{{- .Cert | writeToFile "/certs/myCert/cert.pem" "root" "root" "0644" -}}
{{- .Cert | writeToFile "/certs/myCert/fullchain.pem" "root" "root" "0644" -}}
{{- .CA | writeToFile "/certs/myCert/fullchain.pem" "root" "root" "0644" "append" -}}
{{- end -}}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <p class="pt-3">
                            Maintenant, on va d√©ployer notre premi√®re stack, celle qui contient Consul et Vault.
                            En effet, on travaille avec <strong>deux fichiers docker-compose.yml distincts</strong>,
                            donc deux stacks s√©par√©es :
                        <ul>
                            <li><code>swarm_consul_vault.yml</code> pour Consul et Vault</li>
                            <li><code>swarm_vault_agent.yml</code> pour le Vault-agent</li>
                        </ul>
                        Pour le moment, on ne va lancer que la premi√®re stack, car le Vault-agent bloquerait sur
                        l'authentification sans identifiants.
                        </p>

                        <pre class="bg-dark text-light p-3 rounded"><code class="language-bash"># Avant de d√©ployer, il va nous falloir un reseau
docker network create --driver overlay --attachable --scope swarm secret

# On va √©galement avoir besoin du hash d'une clef de chiffrement sym√©trique de 32 bytes pour Consul 
KEY=$(openssl rand -base64 32); echo "Generated key: $KEY"; echo "$KEY" | docker secret create consul_encrypt_key -

# V√©rification des secrets
docker secret ls

# D√©ploiement de la premi√®re stack (Consul + Vault)
docker stack deploy -c /volume1/docker/secret/swarm_consul_vault.yml secret

# V√©rification que tout est bien d√©ploy√©
docker stack services secret
</code></pre>

                        <div class="alert alert-info mt-3">
                            <strong>Pro tip :</strong>
                            <p class="mb-0">
                                Les secrets Docker sont chiffr√©s au repos et ne sont accessibles qu'aux services
                                autoris√©s. C'est bien mieux que des fichiers .env qui tra√Ænent partout !
                            </p>
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong>Note</strong>
                            <p>
                                Je n'ai malheureusement pas encore trouv√© comment chiffrer le flux r√©seau entre les
                                composants dans le docker de Synology.
                                Ajouter cette option dans la cr√©ation du r√©seau semble bloquer le d√©ploiement des conteneurs ‚Äî probablement
                                √† cause d'un droit manquant au niveau du noyau, ou un autre m√©canisme de s√©curit√©
                                interne.
                            </p>
                            <p>
                                Bref, √ßa ne fonctionne pas pour le moment.
                            </p>
                            <p class="mb-0">
                                Donc, si tu as besoin d'augmenter la s√©curit√©, je te conseille de configurer un mTLS
                                (mutual TLS) pour chiffrer la communication entre tes conteneurs,
                                soit via un proxy type Traefik, soit directement en configurant des certificats dans tes
                                services.
                                Mais √ßa d√©passe le cadre de cet article.
                            </p>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <strong>Attention, √† la clef !</strong>
                            <p>La cl√© de Consul (aka la cl√© gossip) n'est pas critique √† mort, puisqu'elle ne sert
                                qu'√† chiffrer les communications entre les n≈ìuds Consul. Pas touche aux donn√©es
                                elles-m√™mes, donc pas de panique c√¥t√© secrets ou KV.</p>
                            <p>Th√©oriquement, tu peux la remplacer si tu l'as perdu ‚Äî mais bon, c'est la gal√®re :
                                chaque n≈ìud doit conna√Ætre la nouvelle cl√©, il faut g√©rer une p√©riode o√π n≈ìuds
                                supportent l'ancienne et la nouvelle (mode double cl√©, ambiance ‚Äúteam building‚Äù), et
                                une mauvaise manip peut carr√©ment √©clater ton cluster en plusieurs morceaux. Bref,
                                tu m'as compris...</p>
                            <p class="mb-0"> Moralit√© : garde-la bien pr√©cieusement dans un coin. Je me suis m√™me
                                cass√© le dos √† t'√©crire une commande qui te l'affiche, alors profites-en bien !</p>
                        </div>

                        <p class="mt-3">
                            Si tout va bien, tu devrais voir 2 services dans cette premi√®re stack : consul et vault.
                            Souvient toi, le Vault-agent, lui n'est pas lanc√© pour le moment car il a besoin de Vault configur√© pour s'authentifier.
                        </p>
                        <p class="mb-0">
                            Cette gestion en deux stacks s√©par√©es n'est pas tr√®s pratique, mais Swarm ne permet pas
                            de s√©lectionner les services √† d√©ployer dans une stack unique.
                            C'est la solution la plus propre pour avancer sereinement : d'abord d√©ployer ce qui
                            fonctionne, puis, une fois les identifiants pr√™ts, d√©ployer la deuxi√®me stack pour le
                            Vault-agent.
                        </p>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-cogs"></i> √âtape 3 : Initialisation de Vault</h5>
            </div>
            <div class="card-body">
                <p>L√†, c'est le moment crucial. Vault est d√©marr√© mais pas
                    encore initialis√©. On va cr√©er les cl√©s de chiffrement et le
                    token root :</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Initialisation de Vault (√† faire une seule fois !)
docker exec -it $(docker ps -qf "name=secret_vault.1") vault operator init</code></pre>

                <div class="alert alert-danger mt-3 mb-0">

                    <h3><i class="fas fa-skull-crossbones"></i> ULTRA IMPORTANT !</h3>
                    <p>Cette commande va afficher 5 cl√©s de d√©chiffrement et 1
                        token root. <strong>SAUVEGARDE TOUT √áA DANS UN ENDROIT
                            S√õR !</strong> Si tu perds ces cl√©s, tu peux dire
                        adieu √† toutes tes donn√©es Vault. S√©rieusement, pas de
                        blague. Ce n'est pas la m√™me chose que la clef de Consul l√†.</p>
                    <p class="mb-0">Moi je les mets dans mon gestionnaire de
                        mots de passe, certains les impriment et les mettent
                        dans un coffre. √Ä toi de voir, mais <strong>NE LES PERDS
                            PAS</strong> !
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-key"></i> √âtape 4 : V√©rification Consul et Vault</h5>
            </div>
            <div class="card-body">
                <p>Avant d'aller plus loin, il est temps de v√©rifier que Consul et Vault
                    ont d√©marr√© correctement et communiquent l'un avec l'autre, sinon la
                    suite ne sert √† rien vu qu'on va s'appuyer dessus. Comme dit le
                    proverbe du dev : "mieux vaut v√©rifier deux fois que d√©bugger toute
                    la nuit" üòÖ</p>
                <p>On va donc faire un petit check-up de nos services, histoire de
                    s'assurer que tout ce beau monde se parle correctement avant de
                    passer aux choses s√©rieuses.</p>
                <p>Pour commencer, v√©rifions que Consul dans son coin est OK. Il suffit
                    d'aller sur http://__NAS_IP__:8500 (oui, encore une interface web,
                    je sais, on dirait que tout passe par le browser maintenant...)</p>
                <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/consul-ready.png"
                    alt="consul doit afficher status ready">
                <div class="alert alert-info mt-3">
                    <strong>Pro tip :</strong>
                    <p class="mb-0">
                        Si √ßa mouline trop longtemps, c'est soit
                        que le service n'est pas encore compl√®tement d√©marr√© (patience,
                        jeune padawan), soit qu'il y a un souci d'initialisation. Dans ce
                        cas, un petit <code>docker logs consul</code> peut t'√©clairer sur ce
                        qui foire.
                    </p>
                </div>
                <p class=" mt-3">Ton interface devrait t'afficher ton (tes ?)
                    n≈ìud(s) de Consul avec un petit <span class="badge text-bg-success me-1 align-middle">Active
                        voter</span>. Si tu vois √ßa, c'est que Consul a bien pris ses
                    responsabilit√©s de leader du cluster (m√™me si on n'a qu'un seul
                    n≈ìud, il faut bien quelqu'un pour commander !)</p>
                <p>Si c'est le cas, f√©licitations, c'est que √ßa tourne !</p>
                <p class="mt-3">Ensuite on va v√©rifier l'√©tat de la communication entre
                    le Vault et le Consul, pour ce faire clique sur ton serveur
                    "synology-01-consul". C'est l√† que √ßa devient int√©ressant, on va
                    voir si nos deux services se parlent comme de vieux copains ou s'ils
                    se boudent encore...</p>
                <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/consul-vault-seal.png"
                    alt="consul est healthy mais vault est scell√©">
                <p class="mt-3">Et l√†, surprise ! Tu noteras le Vault Sealed Status
                    au-dessus du HealthCheck du Consul. Un beau rouge bien visible,
                    impossible de le louper !</p>
                <p>C'est tout √† fait normal et attendu, on vient √† peine de cr√©er le
                    Vault qui est scell√© pour le moment. D'o√π le pav√© rouge du dessus o√π
                    j'ai bien bien BIEN insist√© pour que tu conserves les 5 cl√©s que
                    l'initialisation t'a g√©n√©r√©es. J'esp√®re que tu ne les as pas perdues
                    dans un coin de ton bureau ou pire, dans un fichier texte nomm√©
                    "passwords.txt" sur le bureau... üò±</p>
                <div class="alert alert-warning">
                    <strong>Point d'attention sur le seal</strong>
                    <p>√Ä chaque fois que le service d√©tectera le moindre truc, le Vault
                        se mettra en "s√©curit√©". C'est comme un chien de garde num√©rique
                        qui se r√©veille d√®s qu'il entend du bruit !</p>
                    <p>C'est son m√©canisme pour prot√©ger tes secrets, c'est tr√®s bien
                        comme √ßa mais cela n√©cessitera que tu viennes toi-m√™me le
                        d√©verrouiller. Oui, c'est chiant, mais c'est le prix de la
                        s√©curit√© !</p>
                    <p>Sache enfin que le verrouillage n'est pas qu'esth√©tique, il
                        bloque compl√®tement les acc√®s. Tant que tu ne le d√©bloques pas,
                        c'est comme coffre-fort ferm√© : impossible de r√©cup√©rer ou
                        d√©poser quoi que ce soit dedans ! M√™me les applications qui
                        essaient d'acc√©der aux secrets vont se prendre un beau "403
                        Forbidden".</p>
                    <strong>En gros :</strong>
                    <p class="mb-0">Red√©marrage = Vault
                        scell√© = Toi qui dois te lever pour le d√©verrouiller. C'est le
                        c√¥t√© moins fun de la s√©curit√©...
                    </p>
                </div>
                <p class="mt-3">Avant de quitter l'interface Consul, si tu vas dans la
                    section Key/Value tu devrais voir une entr√©e "vault" appara√Ætre.
                    C'est le moment "aha !" o√π tu r√©alises que tout commence √† bien
                    communiquer !</p>
                <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/consul-vault-data.png"
                    alt="consul doit afficher le volume vault">
                <p class="mt-3">Oui c'est en effet l√† que Vault va venir √©crire tout son
                    fourbi ! C'est un peu pour √ßa qu'on a install√© Consul d'ailleurs,
                    histoire que les donn√©es ne se baladent pas sur un disque en vrac.
                    Consul fait office de backend de stockage distribu√©, bien plus
                    classe qu'un simple fichier JSON qui tra√Æne...</p>
                <div class="alert alert-info mt-3">
                    <strong>Fun fact :</strong>
                    <p class="mb-0">
                        Si tu regardes bien, tu verras que Vault stocke ses donn√©es sous forme de
                        cl√©s-valeurs dans Consul. C'est du JSON encod√©, mais heureusement on
                        n'aura jamais √† triturer √ßa √† la main (ouf !). De toute fa√ßon si tu
                        t'amuses √† aller voir dedans, tout est chiffr√© et donc illisible !
                        Eh oui, c'est √† √ßa que vont servir les cl√©s, √† d√©chiffrer le tout !
                    </p>
                </div>
                <p class="mt-3">Maintenant, il est temps de d√©verrouiller (enfin !) le
                    Vault, sans quoi comme on ne peut pas y acc√©der on ne pourra ni lire
                    ni √©crire dedans. Direction http://__NAS_IP__:8200. Tu devrais voir
                    une interface dans le genre :
                </p>
                <div class="alert alert-warning">
                    <strong>Note : </strong>
                    <p class="mb-0">Si l'interface met du temps √† charger, c'est normal,
                        Vault prend son temps pour s'assurer que tout est s√©curis√©. La
                        paranoia, c'est son truc !</p>
                </div>
                <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/vault-seal.png"
                    alt="consul doit afficher le volume vault">
                <p>L√† il va te falloir rentrer 3 des 5 cl√©s qu'il nous a g√©n√©r√©es √†
                    l'√©tape pr√©c√©dente. Peu importe lesquelles du moment que les 3 sont
                    diff√©rentes ! C'est le moment de sortir ton petit carnet secret (ou
                    ton gestionnaire de mots de passe, soyons modernes).</p>
                <div class="alert alert-info mt-3">
                    <strong>Explication technique (pour les curieux) :</strong>
                    <p class="mb-0">
                        En fait Vault utilise le üîê Shamir's Secret Sharing qui permet de
                        "diviser un secret (comme une cl√© ma√Ætresse de chiffrement) en
                        plusieurs parts, appel√©es shares, et d√©finir un seuil minimal de
                        parts √† r√©unir pour reconstituer le secret."
                        Bref comme on dit dans le milieu : cherche pas, c'est magique mais
                        c'est bien pratique pour par exemple s√©parer ta cl√© sur plusieurs
                        personnes de confiance et qu'une seule ne soit pas capable de
                        d√©verrouiller seule les infos en cas de p√©pins :D
                    </p>
                </div>
                <div class="alert alert-info mt-3"><strong>En pratique :</strong>
                    <p class="mb-0">
                        On a 5 cl√©s, il en faut 3 pour d√©verrouiller. Donc m√™me si tu perds 2 cl√©s,
                        tu peux encore acc√©der √† tes secrets. Mais si tu en perds 3... ben
                        c'est mort, il faudra tout r√©initialiser (et dire au revoir √† tes
                        donn√©es). D'o√π l'importance de bien les sauvegarder !
                    </p>
                </div>
                <div class="alert alert-info mt-3">
                    <strong>Note : </strong>
                    <p class="mb-0">
                        Pas besoin que tout le monde fasse la queue derri√®re le m√™me
                        ordinateur avec son petit papier si les cl√©s sont r√©parties entre
                        plusieurs personnes. Chacun(e) peut les saisir depuis son propre poste !
                    </p>
                </div>
                <p class="mt-3">Une fois d√©verrouill√©, le Vault te demandera ta cl√©
                    root. Forc√©ment on n'a que ce seul token de connexion possible pour
                    l'instant mais on va y rem√©dier ! Cette cl√© root, c'est un peu comme
                    le compte administrateur ultime : elle peut tout faire, alors on va
                    vite cr√©er des comptes plus limit√©s par la suite.</p>
                <div class="alert alert-warning my-3">
                    <strong>Rappel important :</strong>
                    <p class="mb-0">
                        Cette cl√© root, c'est celle qui √©tait affich√©e lors
                        de l'initialisation, pas les 5 cl√©s de d√©verrouillage. Si tu l'as
                        perdue... ben tu recommences tout depuis le d√©but mais bon je
                        l'avais √©crit en rouge, c'etait pas pour rien !
                    </p>
                </div>
                <p>Normalement √† ce stade tu devrais voir l'interface du Vault (presque)
                    vide. C'est normal, on vient de na√Ætre dans l'√©cosyst√®me Vault, il
                    n'y a encore rien dedans ! C'est comme un frigo neuf : il faut le
                    remplir maintenant.</p>
                <p>L'interface est plut√¥t clean, HashiCorp a fait du bon boulot sur
                    l'UX. Tu vas voir, c'est bien plus user-friendly qu'on pourrait s'y
                    attendre pour un outil de s√©curit√© enterprise.</p>
                <p>Si tu retournes sur celle du Consul l√† o√π on avait le
                    status du Vault Seal, tu ne devrais plus le voir en rouge mais comme
                    √ßa :</p>

                <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/consul-vault-ready.png"
                    alt="consul doit afficher le volume vault">
                <div class="alert alert-success my-3">
                    <strong>Moment de v√©rit√© :</strong>
                    <p class="mb-0">
                        Si tout est vert, c'est que ton installation de
                        Consul et de Vault est op√©rationnelle ! üéâ
                    </p>
                </div>
                <p>Tu as maintenant une base solide pour g√©rer tes secrets de mani√®re
                    professionnelle. Consul stocke tout √ßa proprement, Vault chiffre et
                    s√©curise, et toi tu peux dormir tranquille en sachant que tes mots
                    de passe ne tra√Ænent plus dans des fichiers texte un peu partout.
                </p>
                <div class="alert alert-success mb-0">
                    <strong>üéØ R√©cap de ce qu'on a accompli :</strong>
                    <ul class="mb-0">
                        <li>‚úÖ Consul est up and running, pr√™t √† stocker nos donn√©es</li>
                        <li>‚úÖ Vault communique avec Consul (ils sont copains maintenant)
                        </li>
                        <li>‚úÖ Le processus de d√©verrouillage fonctionne (tes cl√©s sont
                            bonnes !)</li>
                        <li>‚úÖ L'interface web r√©pond correctement</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üîß Phase 2 : Configuration de Vault (le fun
            commence)</h2>

        <p>Maintenant qu'on a un Vault initialis√©, on va le configurer pour
            qu'il devienne notre petite PKI personnelle. C'est l√† que √ßa devient
            int√©ressant !</p>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-network-wired"></i> √âtape 1 : Configuration DNS</h5>
            </div>
            <div class="card-body">
                <p>Avant tout, il faut cr√©er des entr√©es DNS pour nos services.
                    Va dans ton routeur (ou ton serveur DNS) et ajoute :</p>

                <ul>
                    <li><code>vault.internal</code> ‚Üí IP de ton Synology</li>
                    <li><code>consul.internal</code> ‚Üí IP de ton Synology</li>
                </ul>

                <p>Ensuite, on n'oublie pas d'aller configurer le reverse-proxy (celui du Synology dans mon cas) pour
                    faire pointer nos FQDN tout frais en HTTPS dans :
                    <br /><code>Panneau de configuration > Portail de connexion > Avanc√© > Proxy invers√©</code>.
                    <br />Chez moi, √ßa donne √ßa.
                </p>

                <div class="d-flex flex-column flex-lg-row justify-content-center gap-3">
                    <div class="flex-fill">
                        <img class="w-100 img-fluid" src="../../assets/images/synology-vault/consul-https.png"
                            alt="reverse proxy consul">
                    </div>
                    <div class="flex-fill">
                        <img class="w-100 img-fluid" src="../../assets/images/synology-vault/vault-https.png"
                            alt="reverse proxy vault">
                    </div>
                </div>

                <p class="mt-3">Puis, il va te falloir installer le CLI Vault sur ta
                    machine (pas sur le NAS, le syst√®me n'est pas standard tu ne pourras
                    pas le faire).</p>
                <a href="https://developer.hashicorp.com/vault/install" class="link-primary">Documentation
                    officielle pour installer le
                    CLI</a>
                <div class="alert alert-info mt-3">
                    <strong>Explication :</strong>
                    <p class="mb-0">
                        L'interface Web ne
                        permet pas de g√©n√©rer le type d'identifiant dont on va avoir besoin, c'est pour √ßa que l'on
                        installe le CLI.
                    </p>
                </div>
                <p class="mt-3">Une fois que c'est fait, tu peux te connecter √† Vault
                    via le CLI depuis ta machine:</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Configuration de l'adresse Vault
export VAULT_ADDR="https://vault.internal" 

# On ignore le self-signed certificat pour la configuration
export VAULT_SKIP_VERIFY=true 

# Connexion avec le token root
vault login
# Colle ton token root ici</code></pre>

                <div class="alert alert-primary mt-3 mb-0">
                    <strong>üß∞ Caisse √† Outils </strong>
                    <p class="mb-0">
                        Pour plus de d√©tails sur le fonctionnement des reverses proxy consultez <a
                            href="../tool-box/reverse-proxy.html" class="text-decoration-none">l'article ici</a>.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-user-secret"></i> √âtape 2 : Configuration AppRole</h5>
            </div>
            <div class="card-body">
                <p>AppRole, c'est le syst√®me d'authentification qu'on va
                    utiliser pour que Vault-Agent puisse se connecter √† Vault
                    automatiquement. C'est comme un couple login/password, mais
                    en plus s√©curis√©.</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Activation de l'authentification AppRole
vault auth enable approle

# Cr√©ation du r√¥le pour vault-agent
vault write auth/approle/role/vault-agent \
    token_ttl=24h \
    token_max_ttl=72h \
    secret_id_ttl=0 \
    secret_id_num_uses=0 \
    bind_secret_id=true \
    policies=vault-agent-policy</code></pre>

                <p class="mt-3">Ensuite, on r√©cup√®re les identifiants (c'est √ßa
                    qu'on va mettre dans nos secrets Docker pour le Vault-Agent avec de vrai valeurs
                    d'authentification cette fois) :</p>

                <pre class="bg-dark text-light p-3 mb-3 rounded">
<code class="language-bash"># Cr√©ation des secrets pour l'authentification (sur ton PC qui √† Vault CLI)

# R√©cup√©ration du role_id (c'est comme un username)
vault read -field=role_id auth/approle/role/vault-agent/role-id

# G√©n√©ration d'un secret_id (c'est comme un password)
vault write -f -field=secret_id auth/approle/role/vault-agent/secret-id
</code></pre>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Enregistrement des secrets pour l'authentification (sur ton NAS qui √† Docker)
echo "_ROLE_ID_" | docker secret create vault_role_id -
echo "_SECRET_ID_" | docker secret create vault_secret_id -
</code></pre>
                <div class="alert alert-info mt-3 mb-0">
                    <strong>Explication :</strong>
                    <p>Le role_id est fixe et
                        peut √™tre r√©utilis√©. Le secret_id est unique et peut
                        √™tre r√©g√©n√©r√©. C'est ce couple qui permet √† Vault-Agent
                        de s'authentifier.</p>
                    <p>Dans notre configuration, on a choisi que le <strong>secret_id
                            n'a pas de TTL</strong> (<code>secret_id_ttl=0</code>). En
                        clair, le Vault-agent utilise le couple
                        <code>role_id + secret_id</code> pour g√©n√©rer un token
                        d'authentification, qu'il va ensuite rafra√Æchir toutes les 24
                        heures, avec une tol√©rance maximale de 72 heures
                        (<code>token_ttl=24h</code> et <code>token_max_ttl=72h</code>).
                    </p>
                    <p>Si on avait donn√© un TTL au secret_id, √ßa voudrait dire qu'il
                        expire au bout d'un certain temps. Du coup, il faudrait arr√™ter
                        l'agent, g√©n√©rer un nouveau secret_id manuellement, le d√©ployer
                        sur <strong>toutes</strong> les machines, puis red√©marrer
                        l'agent partout‚Ä¶ Autant dire une gal√®re sans fin, pas tr√®s
                        pratique ni scalable !</p>
                    <p class="mb-0">Avec <code>secret_id_ttl=0</code> et
                        <code>secret_id_num_uses=0</code> (utilisations illimit√©es), le
                        secret_id ne p√©rime jamais, ce qui simplifie grandement la
                        gestion c√¥t√© Vault-agent, qui peut tourner en continu sans
                        interruption.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-shield-alt"></i> √âtape 3 : Cr√©ation des politiques
                </h5>
            </div>
            <div class="card-body">
                <p>Les politiques Vault, c'est comme les permissions sur un
                    syst√®me de fichiers : elles d√©finissent qui peut faire quoi.
                    Notre Vault-Agent aura besoin de permissions sp√©cifiques :
                </p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Cr√©ation de la politique pour vault-agent
vault policy write vault-agent-policy - &lt;&lt;EOF
# Permission de cr√©er des certificats
path "pki/issue/internal-server" {
    capabilities = ["create", "update"]
}

# Permission de lire les infos de l'autorit√© de certification
path "pki/ca" {
    capabilities = ["read"]
}

path "pki/ca/pem" {
    capabilities = ["read"]
}
EOF

# Association de la politique au r√¥le AppRole
vault write auth/approle/role/vault-agent policies="vault-agent-policy"
</code></pre>

                <div class="alert alert-success mt-3 mb-0">
                    <strong>Principe de moindre privil√®ge :</strong>
                    <p class="mb-0">
                        Notre agent ne peut que cr√©er des certificats et lire
                        les infos de la CA. Il ne peut pas lire d'autres secrets
                        ou modifier la configuration. C'est √ßa, la s√©curit√©
                        !
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üèõÔ∏è Phase 3 : Cr√©ation de notre PKI (on devient une
            autorit√© de certification)</h2>
        <div class="row mb-3">
            <p class="col-12">Maintenant, on va transformer Vault en autorit√© de certification. En gros,
                on
                va cr√©er notre propre "Let's Encrypt", mais en version maison, qui va g√©rer
                tout seul les certificats pour notre r√©seau interne ‚Äî sans avoir √† sortir
                ces horribles commandes <code>openssl</code> qui donnent des sueurs froides
                !
            </p>
            <div class="col-12 col-lg-4 col-xl-6 col-xxl-3">
                <img class="mx-auto mw-100 img-fluid d-block"
                    src="../../assets/images/synology-vault/enfer-certificat.gif" alt="Asterix & Obelix A38"
                    style="max-width: 400px;">
            </div>
            <div class="col-12 col-lg-8 col-xl-6 col-xxl-9 align-items-center d-flex align-items-center">
                <p class="mx-auto mb-0 mt-3 mt-lg-0">
                    Le sujet peut sembler un peu complexe au premier abord, mais ne
                    t'inqui√©tes pas, je suis l√† pour te guider. Pour rendre tout √ßa plus
                    clair et surtout plus sympa, on va utiliser une analogie simple et
                    famili√®re : celle d'une mairie. Tu vas voir, √ßa va nous aider √†
                    mieux comprendre cet univers un peu technique !
                </p>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-certificate"></i> √âtape 1 : Certificat racine</h5>
            </div>
            <div class="card-body">
                <p>On va commencer par activer le moteur de gestion des certificats :
                    notre PKI (le bureau des papiers d'identit√© d'une mairie) ainsi que
                    cr√©er le certificat racine. Ce certificat racine, c'est un peu comme
                    le maire principal de notre ville - il va pouvoir tamponner et
                    valider tous les autres certificats de nos services. Une fois qu'on
                    aura notre maire en chef install√© √† la mairie, on pourra cr√©er
                    autant de certificats "citoyens" qu'on veut pour nos diff√©rents
                    services, tous avec le tampon officiel qui va bien. </p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Activation du moteur PKI
vault secrets enable pki

# Configuration de la dur√©e de vie maximale (43800h = 5 an)
vault secrets tune -max-lease-ttl=43800h pki

# G√©n√©ration du certificat racine
vault write -field=certificate pki/root/generate/internal \
    common_name="Internal CA" \
    issuer_name="internal-issuer" \
    ttl=43800h

# Configuration des URLs de distribution
vault write pki/config/urls \
    issuing_certificates="http://vault.internal/v1/pki/ca" \
    crl_distribution_points="http://vault.internal/v1/pki/crl"</code></pre>

                <div class="alert alert-info mt-3">
                    <strong>C'est quoi tout √ßa ?
                    </strong>
                    <p>Le d√©tail serait bien trop long √† expliquer ici, la
                        certification c'est un immense concept de s√©curit√© informatique
                        qu'il faut prendre le temps de pr√©senter pas √† pas (et
                        crois-moi, √ßa m√©rite son propre article !). Pour le moment,
                        contentons-nous du jargon essentiel pour comprendre ce qui se
                        passe :</p>
                    <ul class="my-0">
                        <li><strong>common_name:</strong> c'est le nom de ton maire.
                            Oui, "Hidalgo" marcherait aussi, mais l√† c'est pas son
                            mandat !</li>
                        <li><strong>issuer_name :</strong> c'est l'√©tiquette qu'on colle
                            sur son tampon officiel.</li>
                        <li><strong>ttl :</strong> Time To Live, c'est le mandat de ton
                            maire : pendant 5 ans comme les pr√©sidentielles, il pourra
                            d√©livrer des certificats durant cette p√©riode avant de
                            devoir prendre sa retraite !</li>
                        <li><strong>issuing_certificates :</strong> o√π venir chercher
                            les certificats</li>
                        <li><strong>crl_distribution_points :</strong> o√π consulter la
                            liste des certificats r√©voqu√©s (les citoyens d√©chus‚Ä¶ eh oui,
                            on est un peu certificatophobe üò¨)</li>
                    </ul>
                    <p class="mb-0">Ne t'inqui√®te pas si √ßa para√Æt compliqu√©,
                        l'important c'est que Vault va s'occuper de tout √ßa pour nous !
                    </p>
                </div>
                <div class="alert alert-primary mb-0">
                    <strong>üß∞ Caisse √† Outils </strong>
                    <p class="mb-0">
                        Pour plus de d√©tails sur le fonctionnement des certificats de s√©curit√© consultez <a
                            href="../tool-box/certificates.html" class="text-decoration-none">l'article ici</a>.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-cog"></i> √âtape 2 : R√¥le de certificat</h5>
            </div>
            <div class="card-body">
                <p>Maintenant, on va cr√©er un "r√¥le" qui d√©finit quel type de
                    certificats on peut g√©n√©rer - c'est comme cr√©er un tampon sp√©cialis√©
                    √† la mairie. Au lieu d'avoir un seul tampon universel pour tout (ce
                    qui serait un peu le bordel), on cr√©e des tampons sp√©cifiques : un
                    pour les certificats de serveurs web, un autre pour les bases de
                    donn√©es, etc. Notre r√¥le va dire "OK, avec ce tampon-l√†, tu peux
                    cr√©er des certificats pour tel ou tel usage, mais pas n'importe quoi
                    !" :</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Cr√©ation du r√¥le pour les certificats serveur
vault write pki/roles/internal-server \
    allowed_domains="internal" \
    allow_subdomains=true \
    max_ttl="2160h" \
    allow_any_name=false \
    enforce_hostnames=true \
    key_usage="DigitalSignature,NonRepudiation,KeyEncipherment,DataEncipherment" \
    ext_key_usage="server_auth" \
    basic_constraints="CA:FALSE"</code></pre>
                <div class="alert alert-info my-3">
                    <strong>Traduction en fran√ßais :</strong>
                    <ul class="my-0">
                        <li><strong>allowed_domains :</strong> On signe uniquement pour
                            le domaine .internal (notre territoire national, quel beau
                            pays, hein ? üòÑ)</li>
                        <li><strong>allow_subdomains :</strong> ... et ses sous-domaines
                            (toutes nos r√©gions : vault.internal, api.internal, etc.)
                        </li>
                        <li><strong>max_ttl :</strong> Dur√©e de vie maximale des
                            certificats (2160h = 90 jours)</li>
                        <li><strong>allow_any_name :</strong> Pas question de signer
                            n'importe quel nom au hasard</li>
                        <li><strong>enforce_hostnames :</strong> Le nom sur le
                            certificat doit correspondre √† une vraie machine</li>
                        <li><strong>key_usage :</strong> Fonctions de la cl√©, ce qu'elle
                            <strong>peut</strong> faire (signature, chiffrement‚Ä¶)
                        </li>
                        <li><strong>ext_key_usage :</strong> Usage sp√©cifique, ce pour
                            quoi le certificat <strong>va √™tre</strong> utilis√© :
                            (authentification serveur, client, etc.)</li>
                        <li><strong>basic_constraints :</strong> Contraintes du
                            certificat qui ici ne peut pas devenir lui-m√™me une autorit√©
                            pour signer d'autres certificats.</li>
                    </ul>
                </div>
                <p>Rien de bien compliqu√©, ce sont juste nos r√®gles locales : comme dans
                    SimCity, mais avec plus de Matrix dedans.</p>
                <p class="mb-0">Et tout ce qui ne respectera pas ces crit√®res (libre √†
                    toi de les modifier hein √©videmment) eh bien le maire va te
                    rembarrer sec ! Comme √† la pr√©fecture quand il te manque une
                    photocopie : pas de n√©gociation, c'est non et au revoir. </p>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-vial"></i> √âtape 3 : Test de g√©n√©ration</h5>
            </div>
            <div class="card-body">
                <p>Allez, on fait un petit test pour voir si notre PKI
                    fonctionne :</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Test de g√©n√©ration d'un certificat
vault write pki/issue/internal-server \
    common_name="test.internal" \
    ttl="720h"</code></pre>

                <p>Si √ßa marche, tu vas voir plein d'informations s'afficher, notamment
                    le certificat g√©n√©r√© - un peu comme quand tu demandes une carte
                    d'identit√© et qu'ils te sortent une liasse de papiers avec plein de
                    tampons officiels ! Si tu vois d√©filer des lignes de texte cryptique
                    avec des "BEGIN CERTIFICATE" et des caract√®res bizarres, c'est bon
                    signe ! üéâ √áa veut dire que notre maire num√©rique a bien fait son
                    boulot et a pondu un beau certificat tout frais !</p>
                <p>D'ailleurs, essaie de certifier <code>test.external</code> par
                    exemple et tu vas voir que √ßa ne marche pas car on a dit √† notre
                    maire de certifier "internal" et RIEN d'autre ! D'ailleurs comment
                    le pourrait-il vu qu'il n'a pas le tampon pour le faire ??? Si tu
                    demandais au maire de Paris de te d√©livrer un passeport am√©ricain -
                    il te regarderait bizarrement en mode "D√©sol√©, moi je ne m'occupe
                    que des affaires parisiennes !" Notre PKI est pareil : elle est tr√®s
                    √† cheval sur son territoire et refuse cat√©goriquement de signer quoi
                    que ce soit qui ne soit pas dans son domaine de comp√©tence.</p>
                <div class="alert alert-info mt-3 mb-0">
                    <strong>ü§î Et les erreurs de certificat "non reconnu" ?</strong>
                    <p>Il faudra d√©ployer le CA sur tes machines ! Enfin sa cl√© publique
                        pour √™tre pr√©cis. Parce que l√†, on a cr√©√© notre propre maire
                        avec son propre tampon, mais les navigateurs et applications ne
                        le connaissent pas encore. C'est comme si tu d√©barquais √†
                        l'a√©roport avec un passeport d√©livr√© par la R√©publique de ton
                        salon ou si tu brandissais une carte d'identit√© dessin√© sous
                        Paint - techniquement valide selon tes r√®gles, mais personne ne
                        va le reconna√Ætre ! Pour que tes services fassent confiance √†
                        nos certificats "maison", il faudra installer notre certificat
                        racine sur chaque machine. Attention, on installe juste le
                        "registre d'authenticit√© des signatures" du maire, pas ses
                        pouvoirs ! Le maire reste dans notre mairie, sa clef priv√© ne
                        sortira JAMAIS du Vault. Tes machines sauront reconna√Ætre "Ah
                        oui, ce certificat vient bien de notre maire l√©gitime", mais
                        elles ne pourront pas cr√©er des certificats pour autant - c'est
                        juste pour dire "Tu peux lui faire confiance !""</p>
                    <p>Pour le r√©cup√©rer rien de plus simple :</p>
                    <p>Va sur ton Vault :
                        <code>https://vault.internal > pki > issuer > internal-issuer</code>
                    </p>
                    <p>En haut √† droite tu as un onglet Downloads</p>
                    <ul>
                        <li>PEM format : le CA g√©n√©rique pour les syst√®mes Linux<br />Il
                            te suffira de le d√©poser au chemin appropri√© en fonction de
                            ta distribution et de lancer la commande d'int√©gration</li>
                        <li class="mb-3">DER format : le CA reformat√© pour syst√®me Windows<br />C'est
                            encore plus facile, il te suffit de double-cliquer dessus et
                            de suivre les interfaces pour l'installer dans les
                            'certifications racine' de ton ordinateur</li>
                        <img class="mx-auto img-fluid d-block"
                            src="../../assets/images/synology-vault/windows-certificate.png"
                            alt="ne pas aller sur l'interface web de synology">
                    </ul>
                    <p class="mb-0">Je pr√©cise que le CA n'est n√©cessaire que sur les
                        machines qui ne seront pas g√©r√©es par le Vault-agent : ton PC,
                        ton t√©l√©phone etc. Sinon c'est lui qui peut s'en charger et qui
                        s'en chargera. C'est son taff apr√®s tout !</p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">üîß Phase 4 : Configuration de Synology (la partie
            fun)</h2>

        <p>Maintenant, on va pr√©parer Synology pour recevoir nos beaux
            certificats automatiquement g√©n√©r√©s. C'est l√† que √ßa devient
            vraiment int√©ressant ! Notre objectif va √™tre de retirer l'alerte de
            securit√© de l'interface web de Vault et Consul sur notre navigateur web donc
            n'oublie pas de r√©cuperer et installer le CA !</p>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-folder-plus"></i> √âtape 1 : Pr√©paration des dossiers
                </h5>
            </div>
            <div class="card-body">
                <p>Synology stocke ses certificats dans un endroit bien pr√©cis.
                    On va cr√©er notre propre dossier de certificats :</p>

                <pre class="bg-dark text-light p-3 mb-0 rounded">
<code class="language-bash"># Connexion SSH √† ton Synology
# Cr√©ation du dossier pour nos certificats
sudo mkdir -p /usr/syno/etc/certificate/_archive/myCert

# Changement des permissions
sudo chown root:root /usr/syno/etc/certificate/_archive/myCert
sudo chmod 755 /usr/syno/etc/certificate/_archive/myCert</code></pre>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-edit"></i> √âtape 2 : Le fichier INFO</h5>
            </div>
            <div class="card-body">
                <p>Synology utilise un fichier JSON pour lister tous les
                    certificats disponibles. On va ajouter le n√¥tre :</p>

                <pre class="bg-dark text-light p-3 rounded">
<code class="language-bash"># Backup du fichier original (on ne sait jamais)
sudo cp /usr/syno/etc/certificate/_archive/INFO /usr/syno/etc/certificate/_archive/INFO.backup

# √âdition du fichier
sudo nano /usr/syno/etc/certificate/_archive/INFO</code></pre>

                <p class="mb-0">Ajoute cette section <strong>√† la place</strong> la derni√®re
                    accolade fermante du fichier :</p>

                <pre class="bg-dark p-3 rounded">
<code class="language-json">,"myCert": {
    "desc": "Certificat auto-g√©n√©r√© par Vault",
    "services": [
      {
      }
    ],
    "user_deletable": false
  }
}</code></pre>

                <div class="alert alert-warning mt-3">
                    <strong>Attention : </strong>
                    <p class="mb-0">
                        Respecte bien la syntaxe JSON ! Une
                        virgule en trop ou en moins et tout plante. Si tu as peur, fais un
                        backup du fichier avant de le modifier.
                    </p>
                </div>
                <div class="alert alert-danger mt-3">
                    <strong>Danger : </strong>
                    <p>
                        Pendant la proc√©dure, ne va
                        <strong>JAMAIS</strong> sur l'interface web des certificats de
                        Synology
                    </p>
                    <img class="mx-auto img-fluid d-block" src="../../assets/images/synology-vault/synology-no-cert.png"
                        alt="ne pas aller sur l'interface web de synology">
                    <p class="mt-3">Pourquoi ? Eh bien tout simplement car ils ont
                        eu la brillante id√©e d'int√©grer un checker auto-g√©n√©rant si tu
                        cliques sur l'onglet. Ce n'est pas dramatique mais il faudra
                        nettoyer le contenu du dossier que tu viens de cr√©er des
                        certificats auto-g√©n√©r√©s par Synology.</p>
                    <p>
                        De la m√™me mani√®re, n'utilise pas le certificat que l'on g√©n√®re pour la configuration par d√©faut
                        de ton NAS, du moins tant que tu n'as pas g√©n√©r√© des certificats valides. En effet, l'acc√®s √†
                        l'interface
                        web va provoquer une v√©rification du certificat et donc une g√©n√©ration auto-sign√©e par le CA de
                        Synology
                        s'il n'arrive pas √† l'utiliser (mal form√©, expir√©, etc.).
                    </p>
                    <p class="mb-0">
                        En gros, n'utilise ce certificat que pour tes services √† toi, pas pour ceux de Synology et il ne
                        viendra pas t'embeter m√™me si tu passes par son reverse proxy.
                    </p>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <strong>Note : </strong>
                    <p class="mb-0">
                        Si tu veux automatiser les services qui
                        devront utiliser nos certificats, tu peux les indiquer sous forme de
                        liste dans le tableau "services". Mais attention √† ne pas dupliquer
                        des services d√©j√† associ√©s √† d'autres certificats, sinon ton
                        Synology risque de ne pas appr√©cier ! Dans cet article, on va rester
                        simple et les appliquer via l'interface Web, une fois les
                        certificats d√©ploy√©s.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2 class="pb-3 pt-2">ü§ñ Phase 5 : Lancement Vault-Agent</h2>
        <p>Bon, on y est. Le moment o√π tout ce qu'on a pr√©par√© en amont va (normalement) fonctionner. On va
            relancer notre stack <code>docker-compose</code> pour cette fois activer Vault-agent <em>(que l'on avait
                retir√© jusqu'ici)</em> et d√©clencher le d√©ploiement automatique de nos certificats.</p>

    </section>
    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-edit"></i> √âtape 1 : D√©ploiement de la stack Vault-Agent</h5>
            </div>
            <div class="card-body">
                <p>
                    Une fois que tu as les identifiants corrects et que Vault est configur√©, tu peux red√©ployer la stack
                    compl√®te
                    avec le Vault-Agent pour activer la mise √† jour automatique des certificats :
                </p>
                <pre class="bg-dark text-light p-3 rounded"><code class="language-bash"># On d√©ploie maintenant la stack compl√®te avec Vault-Agent
docker stack deploy -c /volume1/docker/secret/swarm_vault_agent.yml  secret</code></pre>

                <p>
                    Ensuite, assure-toi que Vault est bien <strong>unsealed</strong> (c'est-√†-dire d√©verrouill√©). Sinon,
                    rien ne bougera c√¥t√© g√©n√©ration de certificats. Si Vault est encore scell√©, connecte-toi √†
                    l'interface web (<code>https://vault.internal</code>) ou lance plusieurs fois la commande :
                </p>
                <pre
                    class="bg-dark text-light p-3 rounded"><code class="language-bash">vault operator unseal</code></pre>
                <p>
                    Cela d√©verrouille Vault avec les cl√©s d'unseal, n√©cessaires pour que Vault puisse acc√©der √† ses
                    secrets et d√©livrer tes certificats.
                </p>

                <p>√Ä partir de l√†, Vault-Agent va :</p>
                <ul>
                    <li>S'authentifier aupr√®s de Vault gr√¢ce au m√©canisme AppRole (plus s√©curis√© qu'un simple token)
                    </li>
                    <li>Se connecter au serveur Vault pour demander un certificat TLS via l'API PKI</li>
                    <li>G√©n√©rer le certificat en fonction du template que tu as d√©fini (avec les SAN, TTL, etc.)</li>
                    <li>D√©ployer les certificats au bon endroit sur ton NAS Synology (pour que DSM puisse les utiliser)
                    </li>
                    <li>Red√©marrer automatiquement <code>nginx</code> (le serveur web du NAS) pour appliquer les
                        nouveaux certificats en direct</li>
                </ul>

                <p class="mb-0"><em>En clair, tu passes d'une config manuelle et casse-t√™te √† une machine bien huil√©e
                        qui bosse toute seule. Tu peux aller te faire un caf√© pendant que √ßa tourne.</em></p>
            </div>
        </div>
    </section>


    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-edit"></i> √âtape 2 : V√©rification des certificats</h5>
            </div>
            <div class="card-body">
                <p>Maintenant que Vault-Agent a boss√©, il est temps de v√©rifier que tout est bien g√©n√©r√© et √† sa place :
                </p>
                <pre
                    class="bg-dark text-light p-3 rounded"><code class="language-bash">ls -l /usr/syno/etc/certificate/_archive/myCert/</code></pre>

                <p>Tu devrais voir appara√Ætre :</p>
                <div class="row mb-lg-3">
                    <img class="d-block col-12 col-lg-6 mb-3 mb-lg-0"
                        src="../../assets/images/synology-vault/vault-certificates-list.png"
                        alt="certificat install√© sur le serveur">
                    <div class="col-12 col-lg-6">
                        <ul>
                            <li><code>privkey.pem</code> &rarr; ta cl√© priv√©e (ultra sensible, permissions serr√©es √†
                                0600)</li>
                            <li><code>cert.pem</code> &rarr; le certificat public</li>
                            <li><code>fullchain.pem</code> &rarr; certificat + cha√Æne compl√®te (certificat + CA)</li>
                            <li><code>all-certs</code> &rarr; fichier utilis√© par Vault pour g√©rer le suivi des
                                certificats</li>
                        </ul>
                    </div>
                </div>

                <p><strong>Attention :</strong> Le red√©marrage de NGINX est n√©cessaire pour que DSM prenne en compte les
                    nouveaux certificats, mais cela red√©marre aussi Docker. Cela veut dire que tous tes services dans ta
                    stack Consul-Vault (et les autres) vont red√©marrer aussi. Patience, attends que tout soit bien
                    reparti avant d'aller plus loin et n'oublie pas qu'il faudra √† nouveau unseal ton Vault.</p>

                <div class="alert alert-success">
                    <strong>Si tout est l√†, f√©licitations !</strong>
                    <p class="mb-0">Ton Vault-Agent a fait son taf, les certificats sont sign√©s, frais et stock√©s pile
                        l√† o√π Synology les attend. Plus de risques d'erreur humaine ou de certificat p√©rim√© qui fait
                        planter ton NAS.</p>
                </div>
                <div class="alert alert-info mb-0">
                    <strong>Rappel important</strong>
                    <p>Le fichier <code>all-certs</code> joue le r√¥le de d√©clencheur principal pour le renouvellement
                        automatique. Si tu le supprimes, Vault-Agent va d√©tecter son absence et g√©n√©rer un nouveau
                        certificat lors de la prochaine v√©rification programm√©e. C'est super pratique si tu veux ajouter
                        un SAN, ajuster la dur√©e de vie, ou corriger une erreur dans le template de d√©part.</p>

                    <p class="mb-0">Mais attention : Vault-Agent ne compare pas le contenu sur l'h√¥te du fichier, il se
                        base uniquement sur ce qu'il "sait" ‚Äî c'est-√†-dire la configuration initiale d√©finie dans le
                        template (dur√©e, SAN, CN, etc) et le Vault. Si tu modifies un param√®tre mais que tu ne
                        red√©marres
                        pas l'agent, il ne fera pas forc√©ment de mise √† jour imm√©diate.</p>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-edit"></i> √âtape 3 : Activation dans DSM</h5>
            </div>
            <div class="card-body">
                <p>Direction DSM maintenant, dans <strong>Panneau de configuration &gt; S√©curit√© &gt;
                        Certificat</strong>.</p>
                <p>Tu verras appara√Ætre les certificats g√©n√©r√©s par Vault. Il ne reste plus qu'√† les assigner aux
                    services que tu souhaites s√©curiser (Vault, Consul, ton API etc, etc.) via l'onglet
                    "<strong>Param√®tres</strong>".</p>

                <img class="mx-auto img-fluid d-block my-3"
                    src="../../assets/images/synology-vault/vault-agent-cert-installed.png"
                    alt="certificat install√© dans DSM">

                <p>Ce qui est g√©nial, c'est que le lien entre les services (ceux que tu as d√©clar√©s dans le reverse
                    proxy) et les certificats est fait √† un niveau sup√©rieur, via le syst√®me de key-value JSON qu'on a
                    modifi√© manuellement. En clair : ce n'est pas le contenu du certificat qui d√©termine quel service
                    l'utilise, mais bien une r√©f√©rence d√©clarative dans un fichier de config syst√®me.</p>

                <p>R√©sultat : tu peux r√©g√©n√©rer tes certificats, les renouveler, les faire b√©nir par trois PKI
                    diff√©rentes‚Ä¶ tant que tu ne touches pas √† la d√©claration JSON dans le fameux fichier
                    <code>INFO</code>, les assignations resteront intactes !
                </p>

                <p><strong>Attention quand m√™me :</strong> si tu modifies manuellement le fichier <code>INFO</code> (ou
                    que tu fais une erreur de syntaxe, l√†
                    oui, il faudra repasser par la case ‚ÄúAssignation manuelle‚Äù dans DSM.</p>

                <p class="mb-0"><em>Bref, tant que tu laisses le <code>INFO</code> tranquille, DSM reste zen.</em></p>
            </div>
        </div>
    </section>

    <section>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mt-2"><i class="fas fa-edit"></i> √âtape 4 : Et maintenant ?</h5>
            </div>
            <div class="card-body">
                <p>Avec ta PKI maison qui tourne comme une horloge suisse, tu vas pouvoir :</p>
                <ul>
                    <li><strong>√âtendre facilement ta gestion des certificats :</strong> Ajoute autant de templates
                        Vault que n√©cessaire, chacun adapt√© √† un service ou un environnement sp√©cifique.</li>
                    <li><strong>D√©ployer partout :</strong> Sur des machines physiques, des VM, des containers, des API
                        internes, des reverse proxies, bref, tous les points qui ont besoin de TLS.</li>
                    <li><strong>Automatiser la maintenance :</strong> Int√®gre cette gestion dans un repo Git, un
                        pipeline CI/CD, et finis les manips manuelles et les oublis. Moi je vous en propose un
                        <em>...roulement de tambour...</em> : ANSIBLE !
                    </li>
                </ul>

                <p><strong>Pourquoi c'est cool ?</strong> Parce que tu gagnes en s√©curit√© (plus de certificats p√©rim√©s),
                    en fiabilit√© (moins d'erreurs humaines), et en temps (moins de support √† g√©rer). Et en prime, tu
                    pr√©pares ton infrastructure pour √©voluer vers du Kubernetes, des clusters multi-serveurs, et des
                    architectures modernes.</p>

                <div class="alert alert-secondary mb-0">
                    <strong>Envie d'aller plus loin ?</strong>
                    <p class="mb-0">
                        Dans le prochain article, on passera √† la vitesse sup√©rieure : on int√©grera un
                        <code>ACME challenge</code>
                        pour obtenir des certificats publics juste avec Vault (pas de cerbot ou autres), sign√©s par une vraie autorit√© de certification (genre
                        Let's Encrypt). Fini les certificats auto-sign√©s, place √† la
                        gloire publique pour exposer sur Internet nos applications !
                        <strong>Stay tuned !</strong>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section>

        <h2 class="pb-3 pt-2"><i class="fas fa-bug"></i> Debug & Commandes utiles</h5>

            <p>Si jamais √ßa coince ou que tes certificats ne sont pas pris en compte, voici quelques commandes cl√©s
                pour red√©marrer les services essentiels sur ton Synology qui risquent de ce bloquer:</p>
            <pre class="bg-dark text-light p-3 rounded"><code>/usr/syno/bin/synosystemctl restart nginx
synopkg start FileService
synopkg start ContainerManager
</code></pre>
            <p>Ces commandes permettent de relancer :</p>
            <ul>
                <li><strong>NGINX</strong> : le serveur web qui g√®re notamment l'interface DSM et la prise en charge
                    des certificats TLS.</li>
                <li><strong>FileService</strong> : le service de gestion des fichiers, souvent impact√© lors de
                    changements dans les acc√®s s√©curis√©s.</li>
                <li><strong>ContainerManager</strong> : le gestionnaire des conteneurs Docker, n√©cessaire pour que
                    Vault-Agent et autres services fonctionnent correctement.</li>
            </ul>

            <p>Red√©marrer ces services √©vite d'avoir √† red√©marrer compl√®tement ton NAS, ce qui est beaucoup
                plus pratique et rapide.</p>

            <p>Quand √ßa coince, c'est souvent NGINX qui se retrouve avec des certificats dans un √©tat ambigu : un bout √†
                moiti√© remplac√©, un autre qui tra√Æne‚Ä¶ R√©sultat, il ne sait plus quoi charger et plante en silence. Tu
                peux confirmer √ßa avec <code>journalctl</code>, mais franchement, le plus rapide, c'est de faire un
                reset en bonne et due forme.</p>

            <p>Voici la proc√©dure simple pour revenir √† un √©tat propre :</p>
            <ol>
                <li>Commence par <strong>vider manuellement ton dossier de certificats</strong> (ou le renommer si tu
                    veux garder une copie).</li>
                <li>Va dans l'interface DSM, section <strong>Panneau de configuration &gt; S√©curit√© &gt;
                        Certificat</strong>.</li>
                <li>DSM va d√©tecter l'absence de certificats et <strong>g√©n√©rer automatiquement un nouveau certificat
                        auto-sign√©</strong> via son propre CA.</li>
                <li><strong>Red√©marre NGINX</strong> pour qu'il prenne en compte les nouveaux certificats :</li>
            </ol>

            <pre class="bg-dark text-light p-3 rounded"><code>/usr/syno/bin/synosystemctl restart nginx</code></pre>

            <p>Et enfin ‚Äî oui, c'est contre-intuitif mais important ‚Äî <strong>vide √† nouveau le dossier de
                    certificats</strong> car il va te faire plein de fichiers dont tu n'as pas besoin.</p>

            <p>Et voil√† ! Tu es revenu √† z√©ro proprement, avec un DSM content, un NGINX relanc√©, et un Vault pr√™t √†
                red√©poser ses petits PEM tout frais.</p>

            <p>Cette astuce combin√©e aux commandes de red√©marrage te permet de restaurer rapidement un √©tat
                fonctionnel, notamment si un certificat est corrompu ou mal configur√©, sans provoquer d'interruption
                longue sur ton syst√®me.</p>

            <div class="alert alert-info mb-0">
                <strong>Petit conseil</strong>
                <p class="mb-0">
                    Pas de panique : ce ne sont que des certificats. Tant que tu ne remplaces pas les
                    certificats utilis√©s par Synology pour ses services internes, rien de vraiment casse-cou ‚Äî tu
                    peux y aller franco, tu ne vas pas le casser ton NAS !
                </p>
            </div>
    </section>
</div>